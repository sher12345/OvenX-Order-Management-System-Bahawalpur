<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- PWA META TAGS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#8b0000">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"Oven X Official","short_name":"OvenX","start_url":".","display":"standalone","background_color":"#8b0000","theme_color":"#8b0000","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/5973/5973307.png","sizes":"512x512","type":"image/png","purpose":"any"}]}'>

    <title>Oven X - Official Order System</title>
    <style>
        :root { 
            --red: #8b0000; 
            --dark-red: #5e0000;
            --orange: #f37021; 
            --dark-orange: #b34e12;
            --white: #ffffff;
            --bg-body: #fff9f5; 
            --radius-bubble: 25px;
            --wa-green: #25D366;
            --wa-dark: #1a9648;
        }
        * { -webkit-tap-highlight-color: transparent; outline: none; touch-action: manipulation; }
        body.modal-active { overflow: hidden; height: 100vh; }
        body { 
            background: var(--bg-body) !important; 
            color: #333 !important; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding-bottom: 0; overflow-x: hidden;
        }
        #top-sticky-container {
            position: sticky; top: 0; z-index: 2000;
            display: none; flex-direction: column;
            background: var(--bg-body);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-15px);}
            60% {transform: translateY(-7px);}
        }
        @keyframes aggressive-shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .bouncing-logo { animation: bounce 2s infinite; display: inline-block; }
        .btn-3d { transition: transform 0.1s, box-shadow 0.1s; cursor: pointer; border: none; position: relative; user-select: none; }
        .btn-3d:active { transform: translateY(4px) !important; box-shadow: 0 2px 0px rgba(0,0,0,0.2) !important; }
        #gateway-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #2c0000, #000000);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 4000; text-align: center; color: white;
        }
        .gateway-logo { font-size: 60px; font-weight: 900; margin-bottom: 5px; letter-spacing: -2px; }
        .gateway-logo span { color: var(--orange); }
        #gateway-table-note { background: var(--orange); color: white; padding: 12px 25px; border-radius: 50px; font-size: 16px; font-weight: bold; margin-bottom: 30px; display: none; box-shadow: 0 8px 20px rgba(243, 112, 33, 0.4); }
        .gateway-options { display: flex; flex-direction: column; gap: 15px; width: 85%; max-width: 340px; }
        .gate-btn { padding: 20px; border-radius: var(--radius-bubble); font-size: 16px; font-weight: 800; text-transform: uppercase; }
        .btn-red { background: var(--red); color: white; box-shadow: 0 6px 0px var(--dark-red); }
        .btn-orange { background: var(--orange); color: white; box-shadow: 0 6px 0px var(--dark-orange); }
        .btn-outline { background: transparent; color: white; border: 3px solid white; box-shadow: 0 6px 0px rgba(255,255,255,0.2); }
        header { background: var(--red); color: white; padding: 12px 15px; text-align: center; border-bottom: 6px solid var(--orange); display: flex; justify-content: space-between; align-items: center; }
        .header-back-btn { background: var(--orange); color: white; border: none; padding: 8px 15px; border-radius: 15px; font-weight: 900; font-size: 12px; box-shadow: 0 3px 0px var(--dark-orange); }
        .logo { font-size: 24px; font-weight: 900; margin: 0; text-transform: uppercase; flex-grow: 1;}
        .logo span { color: var(--orange); }
        .tab-bar { background: #fff; padding: 10px; display: flex; justify-content: center; gap: 10px; border-bottom: 2px solid #eee; }
        .tab-item { background: #f0f0f0; padding: 12px; border-radius: 20px; font-weight: 800; font-size: 13px; flex: 1; text-align: center; color: #777; transition: 0.2s; }
        .tab-item.active { background: var(--red); color: white; box-shadow: 0 5px 15px rgba(139, 0, 0, 0.3); }

        /* SEARCH & SCROLLER CSS */
        .menu-controls { background: white; padding: 10px 0; border-bottom: 2px solid #eee; }
        .search-box-wrap { padding: 0 15px 10px; }
        .search-input { width: 100%; border: 3px solid #f0f0f0; border-radius: 50px; padding: 12px 20px; font-size: 14px; font-weight: 700; box-sizing: border-box; }
        .search-input:focus { border-color: var(--orange); }
        .category-scroller { display: flex; overflow-x: auto; white-space: nowrap; gap: 10px; padding: 0 15px; scroll-behavior: smooth; }
        .category-scroller::-webkit-scrollbar { display: none; }
        .cat-pill { background: #f0f0f0; color: #777; padding: 8px 18px; border-radius: 50px; font-size: 12px; font-weight: 900; cursor: pointer; transition: 0.2s; flex-shrink: 0; border: 2px solid transparent; }
        .cat-pill.active { background: var(--orange); color: white; box-shadow: 0 4px 10px rgba(243, 112, 33, 0.3); }

        .container, .deals-container { max-width: 600px; margin: auto; padding: 10px 15px 180px 15px; }
        .section-title { font-weight: 900; color: var(--red); margin: 30px 0 15px; font-size: 26px; text-transform: uppercase; display: inline-block; border-bottom: 5px solid var(--orange); padding-bottom: 2px; scroll-margin-top: 180px; }
        .deal-card { background: white; border-radius: 35px; overflow: hidden; margin-bottom: 30px; box-shadow: 0 10px 0px #eee; position: relative; border: 3px solid #fff; }
        .deal-img-top { height: 180px; background-size: cover; background-position: center; border-bottom: 2px solid #f9f9f9; }
        .deal-info-box { padding: 20px; text-align: center; }
        .deal-badge { position: absolute; top: 12px; left: 12px; background: var(--orange); color: white; padding: 6px 14px; border-radius: 20px; font-size: 10px; font-weight: 900; box-shadow: 0 4px 0px var(--dark-orange); z-index: 5; }
        .deal-title { font-weight: 900; color: var(--red); font-size: 22px; text-transform: uppercase; margin-bottom: 5px; }
        .deal-desc { font-size: 13px; color: #666; font-weight: 600; line-height: 1.3; margin-bottom: 15px; display: block;}
        .deal-price { color: var(--orange); font-weight: 900; font-size: 24px; display: block; margin-bottom: 15px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .btn { background-color: #eee; background-size: cover; background-position: center; border: 3px solid #fff; border-radius: 25px; overflow: hidden; display: flex; flex-direction: column; justify-content: flex-end; min-height: 160px; box-shadow: 0 6px 0px #ddd; position: relative; }
        .item-label-box { background: rgba(255, 255, 255, 0.98); padding: 12px; width: 100%; box-sizing: border-box; text-align: center; border-top: 1px solid rgba(0,0,0,0.05); }
        .price-tag { color: var(--orange); font-weight: 900; font-size: 13px; margin-top: 4px; }
        .size-feedback { background: var(--orange) !important; color: white !important; box-shadow: 0 4px 0px var(--dark-orange) !important; }
        #cart-bar { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 450px; background: var(--red); color: white; padding: 12px 20px; border-radius: 50px; display: none; justify-content: space-between; align-items: center; z-index: 1000; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4); border: 2px solid rgba(255,255,255,0.1); }
        .checkout-btn { background: var(--orange); padding: 12px 25px; border-radius: 30px; color: white; font-weight: 900; font-size: 15px; box-shadow: 0 5px 0px var(--dark-orange); }
        #modal-overlay, #welcome-overlay, #flavor-overlay, #size-overlay, #admin-login-overlay, #kitchen-panel-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); display:none; justify-content:center; align-items:center; z-index: 9000; backdrop-filter: blur(8px); }
        #overlay-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 3000; display: none; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .modal { background: var(--white); padding: 30px; border-radius: 35px; width: 85%; max-width: 380px; text-align: center; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .qty-btns { display: flex; justify-content: center; gap: 10px; margin: 20px 0; }
        .qty-btn { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #eee; background: white; font-weight: 900; font-size: 16px; }
        .qty-btn.active { background: var(--red); color: white; border-color: var(--red); box-shadow: 0 4px 0px var(--dark-red); }
        textarea, .big-input { width: 100%; border-radius: 20px; border: 3px solid #f0f0f0; padding: 18px; margin-top: 15px; font-size: 16px; box-sizing: border-box; }
        .next-btn { padding: 18px; border-radius: 20px; border: none; font-weight: 900; width: 100%; margin-bottom: 12px; color: white; display: block; }
        .confirm-btn { background: var(--wa-green); color: white; padding: 20px; border-radius: 25px; font-weight: 900; width: 100%; margin-top: 20px; font-size: 20px; box-shadow: 0 6px 0px var(--wa-dark); }
        .summary-item { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px 20px; border-radius: 25px; margin-bottom: 12px; border: 1px solid #eee; text-align: left; }
        .remove-item-btn { background: #ff4444; color: white; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 15px; font-size: 18px; box-shadow: 0 4px 0px #900; margin-left: 15px; }
        .kitchen-card { background: white; padding: 20px; border-radius: 25px; margin-bottom: 15px; border-left: 10px solid var(--orange); text-align: left; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: 0.3s; }
        .kitchen-card.status-preparing { border-left-color: #007bff; }
        .kitchen-card.status-ready { border-left-color: var(--wa-green); opacity: 0.6; }

        /* KITCHEN ALERTS */
        .kitchen-card.warning { box-shadow: 0 0 25px #ffd700; border-left-color: #ffd700 !important; animation: bounce 2s infinite; }
        .kitchen-card.late { background: #fff1f1; border-left-color: #ff0000 !important; box-shadow: 0 0 35px #ff0000; animation: aggressive-shake 0.2s infinite; border: 2px solid red; }
        .order-timer { font-size: 22px; font-weight: 900; color: #444; margin-top: 5px; font-family: monospace; }
        .late .order-timer { color: #ff0000; }

        .kitchen-badge { position: absolute; top: 15px; right: 15px; font-size: 11px; font-weight: 900; padding: 5px 12px; border-radius: 10px; text-transform: uppercase; }
        .kb-waiting { background: #fff3e0; color: var(--orange); }
        .kb-preparing { background: #e3f2fd; color: #007bff; }
        .kb-ready { background: #e8f5e9; color: var(--wa-green); }
        .delivery-center-wrap { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; margin: 30px 0; }
        .delivery-cta { background: #fff; border: 4px solid var(--orange); padding: 40px 20px; border-radius: 35px; text-align: center; cursor: pointer; box-shadow: 0 10px 0px var(--dark-orange); width: 90%; max-width: 320px; box-sizing: border-box; }
        .chat-bubble { background: white; padding: 20px; border-radius: 25px; margin-bottom: 20px; border: 2px solid #eee; text-align: left; }

        /* SECRET PWA DOWNLOAD TRIGGER */
        #secret-pwa-button {
            position: fixed; bottom: 0; right: 0;
            width: 45px; height: 45px;
            z-index: 9999; background: transparent;
        }
    </style>
</head>
<body>

<!-- HIDDEN DOWNLOAD BUTTON -->
<div id="secret-pwa-button" onclick="handleSecretClick()"></div>

<div id="gateway-screen">
    <div class="bouncing-logo"><p class="gateway-logo">OVEN <span>X</span></p></div>
    <div id="gateway-table-note">üéâ WELCOME! TABLE <span id="gateway-table-id"></span> üéâ</div>
    <div class="gateway-options">
        <button class="gate-btn btn-3d btn-orange" onclick="enterApp('deals')">üî• Best Deals!</button>
        <button class="gate-btn btn-3d btn-red" onclick="enterApp('menu')">üìñ Full Menu</button>
        <button class="gate-btn btn-3d btn-outline" onclick="openAdminLogin()">üë®‚Äçüç≥ KITCHEN PANEL</button>
    </div>
</div>

<div id="top-sticky-container">
    <header id="main-header">
        <button class="header-back-btn btn-3d" onclick="exitToGateway()">‚Üê HOME</button>
        <p class="logo">OVEN <span>X</span> <br><small id="header-table-indicator" style="font-size:10px; font-weight:bold;"></small></p>
        <div style="width:60px;"></div>
    </header>
    <div class="tab-bar" id="nav-tabs">
        <div class="tab-item active" id="tab-menu" onclick="switchTab('menu')">FULL MENU</div>
        <div class="tab-item" id="tab-deals" onclick="switchTab('deals')">HOT DEALS</div>
    </div>
    <!-- MENU CONTROLS (SEARCH + CATEGORIES) -->
    <div class="menu-controls" id="menu-controls">
        <div class="search-box-wrap">
            <input type="text" id="menuSearch" class="search-input" placeholder="üîç Search food..." oninput="handleSearch(this.value)">
        </div>
        <div class="category-scroller" id="category-bar"></div>
    </div>
</div>

<div id="deals-container" class="deals-container"><div id="deals-list"></div></div>
<div class="container" id="menu-container" style="display:none;"></div>

<div id="cart-bar">
    <div><span id="cart-count" style="font-size:11px; font-weight:900; color:var(--orange);">ITEMS: 0</span><br><span id="cart-total" style="font-size:20px; font-weight:900;">Rs 0</span></div>
    <div class="checkout-btn btn-3d" onclick="startCheckout()">CHECKOUT ‚Üí</div>
</div>

<div id="admin-login-overlay">
    <div class="modal">
        <h2 style="color:var(--red); font-weight:900;">Kitchen Access</h2>
        <p>Type the secret code üçï</p>
        <input type="text" id="adminPassword" placeholder="Secret Code" class="big-input" oninput="handlePassInput(this)" autocomplete="off" style="text-align:center; letter-spacing:4px; font-size:22px;">
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="next-btn btn-3d" style="background:#888;" onclick="closeAdminLogin()">BACK</button>
            <button class="next-btn btn-3d" style="background:var(--red);" onclick="verifyAdmin()">UNLOCK</button>
        </div>
    </div>
</div>

<div id="kitchen-panel-overlay">
    <div class="modal" style="max-width:600px; width:95%; height:90vh;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0; color:var(--red); font-weight:900;">LIVE KITCHEN</h2>
            <button class="header-back-btn btn-3d" onclick="closeKitchenPanel()">EXIT</button>
        </div>
        <div id="kitchen-orders-list"></div>
        <button class="next-btn btn-3d" style="background:#444; margin-top:30px;" onclick="clearReadyOrders()">CLEAR READY ORDERS</button>
    </div>
</div>

<div id="flavor-overlay"><div class="modal"><h3 id="flavor-title" style="color:var(--red); font-weight:900;">Pick Flavor</h3><div class="grid" id="flavor-grid"></div><button onclick="closeModals()" style="margin-top:25px; border:none; background:none; color:#bbb; font-weight:900;">CANCEL</button></div></div>
<div id="welcome-overlay"><div class="modal"><h2 style="color:var(--red); font-weight:900;">HEY THERE! üëã</h2><p id="welcome-msg">Where do you want your food?</p><div class="input-group" id="service-options-container"></div></div></div>
<div id="modal-overlay"><div class="modal"><h3 id="modal-item-name" style="color:var(--red); font-weight:900; margin-top:0;"></h3><p style="font-weight:bold; color:#777;">How many?</p><div class="qty-btns"><button class="qty-btn btn-3d" onclick="setQty(1)">1</button><button class="qty-btn btn-3d" onclick="setQty(2)">2</button><button class="qty-btn btn-3d" onclick="setQty(3)">3</button><button class="qty-btn btn-3d" onclick="setQty(4)">4</button><button class="qty-btn btn-3d active" onclick="setQty(5)">5+</button></div><textarea id="special-note" placeholder="Any special notes?"></textarea><div style="margin-top:25px; display:flex; gap:12px;"><button onclick="closeModals()" class="btn-3d" style="flex:1; padding:15px; border-radius:20px; background:#eee;">BACK</button><button onclick="addToCartFinal()" class="btn-3d" style="flex:1.5; padding:15px; border-radius:20px; background:var(--orange); color:white; font-weight:900; box-shadow:0 5px 0px var(--dark-orange);">ADD TO BAG</button></div></div></div>
<div id="size-overlay"><div class="modal"><h3 style="font-weight:900;">Select Size</h3><div class="grid" id="size-grid"></div><button onclick="closeModals()" style="margin-top:20px; border:none; background:none; color:gray; font-weight:900;">CANCEL</button></div></div>
<div id="overlay-screen"><button class="header-back-btn btn-3d" id="checkout-back-btn" style="margin-bottom:20px; padding:12px 25px;">‚Üê BACK</button><div id="checkout-content"></div></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // OPPO COMPATIBILITY: Initialize Audio inside function to prevent crash
    let audioCtx = null;
    function playClick(type = 'pop') { 
        try { 
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator(); 
            const gain = audioCtx.createGain(); 
            osc.type = 'sine'; 
            if(type === 'pop') { osc.frequency.setValueAtTime(600, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(10, audioCtx.currentTime + 0.1); } 
            else if(type === 'thud') { osc.frequency.setValueAtTime(300, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(1, audioCtx.currentTime + 0.2); } 
            else if(type === 'siren') { 
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(400, audioCtx.currentTime); 
                osc.frequency.linearRampToValueAtTime(800, audioCtx.currentTime + 0.2);
                osc.frequency.linearRampToValueAtTime(400, audioCtx.currentTime + 0.4);
            }
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + (type === 'siren' ? 0.4 : 0.1)); 
            osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + (type === 'siren' ? 0.4 : 0.1)); 
        } catch(e) { console.log("Audio skipped"); } 
    }

    const SUPABASE_URL = "https://frjcefugnvitexxcated.supabase.co";
    const SUPABASE_KEY = "sb_publishable_iymHBHXzWCXmXI4yUfQ_XQ__5EW47HJ";
    let sb = null;
    try {
        sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } catch(e) { console.error("Supabase load error"); }

    let cart = [], selectedItem = null, selectedQty = 1, orderType = "", tableNum = "", userAddress = "", delCharge = 0, chkStep = 1, dealChoices = [], currentFlavorStep = 0, isQRScan = false, kitchenInterval = null;
    
    try {
        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.has('table')) { 
            isQRScan = true; 
            tableNum = urlParams.get('table').toUpperCase(); 
            document.getElementById('gateway-table-id').innerText = tableNum; 
            document.getElementById('gateway-table-note').style.display = 'block'; 
            document.getElementById('header-table-indicator').innerText = "(TABLE " + tableNum + ")"; 
        }
    } catch(e) { console.error("URL Parsing failed"); }

    const menuData = {
        "Starter üçü": [{name: "Plain Fries", price: {Reg: 230, Large: 300}}, {name: "Loaded Fries", price: 599}, {name: "Pizza Fries", price: 720}, {name: "Dragon Shots", price: 399}, {name: "Oven Baked Wings", price: {Reg: 399, Large: 780}}, {name: "Peri-Peri Wings", price: {M: 399, L: 780}}, {name: "Hot Wings", price: {M: 399, L: 780}}, {name: "Honey Chili Wings", price: {M: 449, L: 880}}, {name: "Cheese Sticks", price: 449}, {name: "Meat Sticks", price: 449}, {name: "Nuggets", price: {M: 350, L: 650}}],
        "Sandwich ü•™": [{name: "Health Harvest", price: 599}, {name: "Khameera Sandwich", price: 699}, {name: "Club Sandwich", price: 599}],
        "Fried Burger üçî": [{name: "Chicken Patty Burger", price: 299}, {name: "Zinger Burger", price: 420}, {name: "Mighty Burger", price: 699}, {name: "Chipotle Burger", price: 649}, {name: "Crispy Jalapeno", price: 549}, {name: "Stuff Jalapeno", price: 649}],
        "Grilled Burger ‚ô®Ô∏è": [{name: "CM Grilled", price: 499}, {name: "Smokey Grilled", price: 550}, {name: "Peri Peri Grilled", price: 749}, {name: "Drizzler X", price: 749}, {name: "Jalapeno Blaze", price: 749}, {name: "Mexi Fiesta", price: 749}],
        "Pan Pizza üçï": [{name: "Chicken Tikka", price: {S:499, M:999, L:1549}}, {name: "Chicken Fajita", price: {S:499, M:999, L:1549}}, {name: "Chicken Supreme", price: {S:499, M:999, L:1549}}, {name: "Cheese Lover", price: {S:499, M:999, L:1549}}, {name: "Veg Lover", price: {S:499, M:999, L:1549}}, {name: "Sicilian Pizza", price: {S:499, M:999, L:1549}}],
        "Premium Pizza üåü": [{name: "BBQ Pizza", price: {M:1199, L:1699}}, {name: "Creamy Dreamy", price: {M:1199, L:1699}}, {name: "OvenX Special Premium", price: {M:1199, L:1699}}, {name: "Bonfire Pizza", price: {M:1199, L:1699}}],
        "Deep Dish Pizza üç≤": [{name: "Mild Butter", price: {M:1749, L:2449}}, {name: "OvenX Special Deep Dish", price: {M:1749, L:2449}}],
        "Extreme Pizza üå∂Ô∏è": [{name: "Extreme Peri Peri", price: {M:1499, L:2049}}, {name: "Extreme Flaming Kabab", price: {M:1499, L:2049}}, {name: "Crispy Extreme", price: {M:1499, L:2049}}],
        "Craft My Own Pizza üé®": [{name: "Kabab Crust", price: {Med: 1399, Large: 1799}}, {name: "Crown Crust", price: {Med: 1399, Large: 1799}}, {name: "Cheese Crust", price: {Med: 1399, Large: 1799}}, {name: "Crusti Thin", price: 1699}],
        "Platters üç±": [{name: "Khameera Sandwich Platter", price: 699}, {name: "Calzone Platter", price: 899}, {name: "Behari Platter", price: 949}],
        "Pasta üçù": [{name: "Alfredo Pasta", price: 699}, {name: "OvenX Flaming Pasta", price: 650}, {name: "Fire Kissed Pasta", price: 699}, {name: "X-Special Pasta", price: 749}],
        "Wraps & Rolls üåØ": [{name: "Chipotle Wrap", price: 699}, {name: "BBQ Wrap", price: 599}, {name: "Donar Kabab", price: 749}, {name: "Crunch Wrap", price: 449}, {name: "Zingeratha Roll", price: 449}, {name: "Paratha Roll", price: 449}, {name: "Malai Roll", price: 449}, {name: "Behari Roll", price: 749}, {name: "Peri Peri Wrap", price: 749}],
        "Bar Menu ü•§": [{name: "Coke Buddy", price: 130}, {name: "Sprite Buddy", price: 130}, {name: "Coke 1 Liter", price: 190}, {name: "Next Cola 1 Liter", price: 170}, {name: "Coke 1.5L", price: 230}, {name: "Sprite 1.5L", price: 230}, {name: "Water Small", price: 99}, {name: "Water Large", price: 170}]
    };

    menuData["Pan/Premium"] = [...menuData["Pan Pizza üçï"], ...menuData["Premium Pizza üåü"]];

    const dealsData = [
        { name: "Midnight Deal 1", desc: "2x Med Extreme Pizzas + 1.5L Drink", price: 2699, badge: "HOT DEAL", flavorsNeeded: [{label: "Pizza 1", cat: "Extreme Pizza üå∂Ô∏è"}, {label: "Pizza 2", cat: "Extreme Pizza üå∂Ô∏è"}], fixedItems: ["1.5L Soft Drink"] },
        { name: "Midnight Deal 2", desc: "1x Large wings + 2x Large Pan Pizzas + 1.5L Drink", price: 3249, badge: "SAVER", flavorsNeeded: [{label: "Pizza 1", cat: "Pan Pizza üçï"}, {label: "Pizza 2", cat: "Pan Pizza üçï"}], fixedItems: ["1x Large Hot Wings", "1.5L Soft Drink"] },
        { name: "Midnight Deal 3", desc: "1x Large wings + 2x Large Premium Pizzas + 1.5L Drink", price: 3649, badge: "PREMIUM", flavorsNeeded: [{label: "Pizza 1", cat: "Premium Pizza üåü"}, {label: "Pizza 2", cat: "Premium Pizza üåü"}], fixedItems: ["1x Large Hot Wings", "1.5L Soft Drink"] },
        { name: "Midnight Deal 4", desc: "1x Med Extreme Pizza + 1x Large Extreme Pizza + 1.5L Drink", price: 3149, badge: "MIX DEAL", flavorsNeeded: [{label: "Medium Pizza", cat: "Extreme Pizza üå∂Ô∏è"}, {label: "Large Pizza", cat: "Extreme Pizza üå∂Ô∏è"}], fixedItems: ["1.5L Soft Drink"] },
        { name: "Family Feast", desc: "2 Med Pizzas + 2 Zingers + 1L Drink + 6 Wings", price: 2299, badge: "FAMILY", flavorsNeeded: [{label: "Pizza 1", cat: "Pan/Premium"}, {label: "Pizza 2", cat: "Pan/Premium"}], fixedItems: ["2x Zinger Burgers", "1L Drink", "6x Wings"] },
        { name: "Extreme Buddy", desc: "1 Medium Extreme Pizza + Free 1L Drink", price: 1449, badge: "BEST SELLER", flavorsNeeded: [{label: "Pizza Flavor", cat: "Extreme Pizza üå∂Ô∏è"}], fixedItems: ["1L Drink"] },
        { name: "Burger Deal 1", desc: "2 Zingers + 1 Reg Fries + 2 Drinks", price: 999, badge: "DELIVERY", fixedItems: ["2x Zinger Burgers", "1x Regular Fries", "2x Drinks"] },
        { name: "Burger Deal 2", desc: "1 Zinger + 1 Reg Fries + 1 345ml Drink + 2 Wings", price: 990, badge: "DELIVERY", fixedItems: ["1x Zinger Burger", "1x Regular Fries", "1x 345ml Buddy Drink", "2x Pcs Wings"] },
        { name: "Burger Deal 3", desc: "4 Classic Zingers + 2 Reg Fries + 1L Drink + 6 Wings", price: 1990, badge: "DELIVERY", fixedItems: ["4x Classic Zinger Burgers", "2x Regular Fries", "1x 1 Liter Drink", "6x Pcs Wings"] },
        { name: "01 PIZZA DEAL", desc: "1 Large Pizza (Pan) + 1L Drink", price: 1299, badge: "DELIVERY", flavorsNeeded: [{label: "Pizza", cat: "Pan Pizza üçï"}], fixedItems: ["1L Drink"] },
        { name: "02 PIZZA DEAL", desc: "1 Large Pizza (Premium) + 1L Drink", price: 1499, badge: "DELIVERY", flavorsNeeded: [{label: "Pizza", cat: "Premium Pizza üåü"}], fixedItems: ["1L Drink"] },
        { name: "03 PIZZA DEAL", desc: "1 Large Crown Pizza + 1L Drink", price: 1599, badge: "DELIVERY", flavorsNeeded: [{label: "Crown Flavor", cat: "Craft My Own Pizza üé®"}], fixedItems: ["1L Drink"] },
        { name: "04 PIZZA DEAL", desc: "1 Large Extreme Pizza + 1L Drink", price: 1999, badge: "DELIVERY", flavorsNeeded: [{label: "Extreme Flavor", cat: "Extreme Pizza üå∂Ô∏è"}], fixedItems: ["1L Drink"] }
    ];

    const imgMap = { "plain fries": "https://images.unsplash.com/photo-1630384066272-117519576150", "loaded fries": "https://images.unsplash.com/photo-1585109649139-366815a0d713", "pizza fries": "https://images.unsplash.com/photo-1541592106381-b31e9677c0e5", "shots": "https://images.unsplash.com/photo-1562967914-6c8273970a2b", "wings": "https://images.unsplash.com/photo-1527477396000-e27163b481c2", "nuggets": "https://images.unsplash.com/photo-1562967914-6c8273970a2b", "health harvest": "https://images.unsplash.com/photo-1539252554453-80ab65ce3586", "sandwich": "https://images.unsplash.com/photo-1528735602780-2552fd46c7af", "zinger": "https://images.unsplash.com/photo-1513185158878-8d8c19671f51", "burger": "https://images.unsplash.com/photo-1568901346375-23c9450c58cd", "pizza": "https://images.unsplash.com/photo-1513104890138-7c749659a591", "pasta": "https://images.unsplash.com/photo-1473093226795-af9932fe5856", "wrap": "https://images.unsplash.com/photo-1626700051175-6818013e1d4f", "roll": "https://images.unsplash.com/photo-1610393790034-7577897050e8", "drink": "https://images.unsplash.com/photo-1581006852262-e4307cf6283a" };

    function setScrollLock(lock) { if(lock) document.body.classList.add('modal-active'); else document.body.classList.remove('modal-active'); }
    function enterApp(target) { playClick('thud'); document.getElementById('gateway-screen').style.display = 'none'; document.getElementById('top-sticky-container').style.display = 'flex'; if(tableNum && orderType === "") { renderServiceOptions(); document.getElementById('welcome-overlay').style.display = 'flex'; setScrollLock(true); } if(target === 'deals') switchTab('deals'); else switchTab('menu'); }
    function renderServiceOptions() { const container = document.getElementById('service-options-container'); let html = `<button class="next-btn btn-3d" onclick="setInitialService('Dine-In')" style="background:#007bff; box-shadow: 0 6px 0px #0056b3;">üçΩÔ∏è Eat Here (7% SC)</button><button class="next-btn btn-3d" onclick="setInitialService('Takeaway')" style="background:#6c757d; box-shadow: 0 6px 0px #495057;">ü•° Take Home</button>`; if (!isQRScan) { html += `<button class="next-btn btn-3d" style="background:var(--red); box-shadow: 0 6px 0px var(--dark-red);" onclick="setInitialService('Delivery')">üöö Delivery</button>`; } container.innerHTML = html; }
    function exitToGateway() { playClick('pop'); document.getElementById('gateway-screen').style.display = 'flex'; document.getElementById('top-sticky-container').style.display = 'none'; document.getElementById('cart-bar').style.display = 'none'; setScrollLock(false); }
    
    function switchTab(tab) { 
        playClick('pop'); 
        if(tab === 'menu') { 
            document.getElementById('menu-container').style.display = 'block'; 
            document.getElementById('deals-container').style.display = 'none'; 
            document.getElementById('tab-menu').classList.add('active'); 
            document.getElementById('tab-deals').classList.remove('active'); 
            document.getElementById('menu-controls').style.display = 'block'; // Show Search
            renderPublicMenu(); 
        } else { 
            document.getElementById('menu-container').style.display = 'none'; 
            document.getElementById('deals-container').style.display = 'block'; 
            document.getElementById('tab-deals').classList.add('active'); 
            document.getElementById('tab-menu').classList.remove('active'); 
            document.getElementById('menu-controls').style.display = 'none'; // Hide Search
            renderPublicDeals(); 
        } 
    }

    function openOrderFlow(item) {
        playClick('pop');
        selectedItem = JSON.parse(JSON.stringify(item));
        dealChoices = []; currentFlavorStep = 0;
        if (selectedItem.flavorsNeeded) {
            startFlavorSelection();
        } else if (item.price && typeof item.price === 'object') {
            const sizeGrid = document.getElementById('size-grid'); sizeGrid.innerHTML = '';
            for (let s in item.price) {
                let sBtn = document.createElement('div'); sBtn.className = 'btn btn-3d';
                sBtn.innerHTML = `<div class="item-label-box"><div>${s}</div><div class="price-tag">Rs ${item.price[s]}</div></div>`;
                sBtn.onclick = function() { playClick('pop'); selectedItem.name += " (" + s + ")"; selectedItem.price = item.price[s]; document.getElementById('size-overlay').style.display = 'none'; openQtyModal(); };
                sizeGrid.appendChild(sBtn);
            }
            document.getElementById('size-overlay').style.display = 'flex'; setScrollLock(true);
        } else { openQtyModal(); }
    }
    
    function startFlavorSelection() {
        const step = selectedItem.flavorsNeeded[currentFlavorStep];
        document.getElementById('flavor-title').innerText = "Pick " + step.label;
        const grid = document.getElementById('flavor-grid'); grid.innerHTML = '';
        let flavors = menuData[step.cat] || [];
        flavors.forEach(f => {
            const b = document.createElement('div'); b.className = 'btn btn-3d'; b.innerHTML = `<div class="item-label-box"><div>${f.name}</div></div>`;
            b.onclick = function() {
                b.classList.add('size-feedback'); 
                playClick('pop'); 
                setTimeout(() => {
                    dealChoices.push(`${selectedItem.flavorsNeeded[currentFlavorStep].label}: ${f.name}`); currentFlavorStep++;
                    if (currentFlavorStep < selectedItem.flavorsNeeded.length) startFlavorSelection();
                    else { document.getElementById('flavor-overlay').style.display = 'none'; selectedItem.flavorNotes = dealChoices.join(", "); openQtyModal(); }
                }, 100);
            };
            grid.appendChild(b);
        });
        document.getElementById('flavor-overlay').style.display = 'flex'; setScrollLock(true);
    }
    
    function openQtyModal() { document.getElementById('modal-item-name').innerText = selectedItem.name; setQty(1); document.getElementById('modal-overlay').style.display = 'flex'; setScrollLock(true); }
    function setQty(q) { playClick('pop'); selectedQty = q; document.querySelectorAll('.qty-btn').forEach((b, i) => { b.classList.remove('active'); if (i === (q===5?4:q-1)) b.classList.add('active'); }); }
    function closeModals() { document.getElementById('modal-overlay').style.display = 'none'; document.getElementById('size-overlay').style.display = 'none'; document.getElementById('flavor-overlay').style.display = 'none'; setScrollLock(false); }
    function addToCartFinal() { playClick('thud'); const note = document.getElementById('special-note').value; let finalDetail = (selectedItem.flavorNotes || "") + (selectedItem.fixedItems ? "\nIncludes: " + selectedItem.fixedItems.join(", ") : "") + (note ? "\nNote: " + note : ""); cart.push({ ...selectedItem, qty: selectedQty, note: finalDetail }); updateCartBar(); closeModals(); }
    function updateCartBar() { const totalItems = cart.reduce((s, i) => s + i.qty, 0); const totalPrice = cart.reduce((s, i) => s + (i.price * i.qty), 0); document.getElementById('cart-count').innerText = `ITEMS: ${totalItems}`; document.getElementById('cart-total').innerText = `Rs ${totalPrice}`; document.getElementById('cart-bar').style.display = totalItems > 0 ? 'flex' : 'none'; }
    function removeItem(idx) { playClick('pop'); cart.splice(idx, 1); updateCartBar(); if(cart.length === 0) { document.getElementById('overlay-screen').style.display = 'none'; setScrollLock(false); } else renderFinalSummary(delCharge); }
    function startCheckout() { playClick('thud'); document.getElementById('overlay-screen').style.display = 'block'; setScrollLock(true); renderServiceTypeStep(); }
    function renderServiceTypeStep() { chkStep = 1; document.getElementById('checkout-content').innerHTML = `<div class="chat-bubble">Where do you want your food?</div><div class="input-group" id="checkout-options-buttons"></div>`; renderCheckoutServiceButtons(); }
    function renderCheckoutServiceButtons() { const container = document.getElementById('checkout-options-buttons'); let html = `<button class="next-btn btn-3d" onclick="selectService('Dine-In')" style="background:#007bff; box-shadow: 0 6px 0px #0056b3;">üçΩÔ∏è Eat Here (7% SC)</button><button class="next-btn btn-3d" onclick="selectService('Takeaway')" style="background:#6c757d; box-shadow: 0 6px 0px #495057;">ü•° Take Home</button>`; if (!isQRScan) { html += `<button class="next-btn btn-3d" style="background:var(--red); box-shadow: 0 6px 0px var(--dark-red);" onclick="selectService('Delivery')">üöö Delivery</button>`; } container.innerHTML = html; }
    function selectService(type) { playClick('pop'); orderType = type; if(type === 'Dine-In') { if(tableNum) renderFinalSummary(0); else renderTableStep(); } else if(type === 'Takeaway') renderFinalSummary(0); else renderAddressStep(); }
    function renderTableStep() { chkStep = 2; document.getElementById('checkout-content').innerHTML = `<div class="chat-bubble">What is your <b>Table Number</b>?</div><div class="input-group"><input type="text" id="manualTable" placeholder="Example: A1" class="big-input"><button class="next-btn btn-3d" style="background:var(--red); box-shadow:0 6px 0px var(--dark-red);" onclick="playClick('thud'); tableNum=document.getElementById('manualTable').value.toUpperCase(); renderFinalSummary(0)">NEXT</button></div>`; }
    function renderAddressStep() { chkStep = 2; document.getElementById('checkout-content').innerHTML = `<div class="chat-bubble">üöö Click the map to see delivery costs!</div><div class="delivery-center-wrap"><div class="delivery-cta btn-3d" onclick="playClick('pop'); loadDeliverySystem()" style="background:#fff3e0;"><span style="font-size:50px;">üó∫Ô∏èüí®</span><br><span style="font-weight:900;">FIND MY PRICE</span></div></div>`; }
    function loadDeliverySystem() { document.getElementById('checkout-content').innerHTML = `<div class="chat-bubble">Once you see the price, wait for the green button! üëá</div><iframe id="delIframe" src="https://oven-x-deliverer--ovenxoperations.replit.app/ovenxdeliverycalculator?view=customer" style="width:100%; height:400px; border:4px solid var(--orange); border-radius:30px;" allow="geolocation"></iframe><div id="unlock-area" style="margin-top:15px; text-align:center;"><button class="next-btn" style="background:#ccc; box-shadow:0 6px 0px #888; cursor:not-allowed; opacity:0.6;">I'M LOOKING... üîç</button></div>`; setTimeout(() => { if(document.getElementById('unlock-area')) { playClick('pop'); document.getElementById('unlock-area').innerHTML = `<button class="next-btn btn-3d" onclick="playClick('thud'); renderDeliveryFeeInput()" style="background:var(--wa-green); box-shadow: 0 6px 0px var(--dark-dark-green); border:none;">I SAW THE PRICE! üí∞ DONE ‚Üí</button>`; } }, 5000); }
    function renderDeliveryFeeInput() { document.getElementById('checkout-content').innerHTML = `<div class="chat-bubble">üí∞ How much was the delivery fee?</div><input type="number" id="manualFee" placeholder="Example: 100" class="big-input"><button class="next-btn btn-3d" style="background:var(--red); box-shadow:0 6px 0px var(--dark-red); margin-top:15px;" onclick="playClick('thud'); saveFee()">NEXT</button>`; }
    function saveFee() { let f = document.getElementById('manualFee').value; if(!f) return alert("Please enter price!"); delCharge = f; renderDeliveryAddressInput(); }
    function renderDeliveryAddressInput() { document.getElementById('checkout-content').innerHTML = `<div class="chat-bubble">üè† Where should we bring your food?</div><textarea id="manualAddr" placeholder="Enter address..." class="big-input"></textarea><button class="next-btn btn-3d" style="background:var(--orange); box-shadow:0 6px 0px var(--dark-orange); margin-top:15px;" onclick="playClick('thud'); saveAddr()">SHOW SUMMARY ‚Üí</button>`; }
    function saveAddr() { let a = document.getElementById('manualAddr').value; if(!a) return alert("Please enter address!"); userAddress = a; renderFinalSummary(delCharge); }

    let adminPassTracker = "";
    function openAdminLogin() { playClick('pop'); adminPassTracker = ""; document.getElementById('adminPassword').value = ""; document.getElementById('admin-login-overlay').style.display = 'flex'; setScrollLock(true); }
    function closeAdminLogin() { document.getElementById('admin-login-overlay').style.display = 'none'; setScrollLock(false); }
    function handlePassInput(el) { let cur = el.value; if(cur.length < adminPassTracker.length) adminPassTracker = adminPassTracker.substring(0, cur.length); else { let last = cur.substring(cur.length-1); if(last !== "üçï") adminPassTracker += last; } el.value = "üçï".repeat(adminPassTracker.length); }
    
    function verifyAdmin() { 
        if(adminPassTracker === "123") { 
            playClick('thud'); 
            closeAdminLogin(); 
            openKitchenPanel(); 
            if ("Notification" in window) {
                Notification.requestPermission();
            }
            setupRealtimeNotifications();
        } else { 
            alert("Denied!"); 
            adminPassTracker = ""; 
            document.getElementById('adminPassword').value = ""; 
        } 
    }

    async function finalSubmitOrder() {
        playClick('thud');
        const foodTotal = cart.reduce((s, i) => s + (i.price * i.qty), 0);
        let sc = (orderType === "Dine-In") ? Math.round(foodTotal * 0.07) : 0;
        const itemsListText = cart.map(i => i.qty + "x " + i.name + (i.note ? " ["+i.note+"]" : "")).join("\n");
        const orderObj = { type: orderType, location: orderType === 'Dine-In' ? "Table " + tableNum : userAddress, items: itemsListText, status: 'WAITING' };
        
        try {
            if(sb) await sb.from('kitchen_orders').insert([orderObj]);
        } catch(e) { console.log(e); }
        
        let headerInfo = `*OVEN X - ${orderType.toUpperCase()} ORDER*`;
        if (tableNum && orderType === 'Dine-In') headerInfo += `\n*TABLE: ${tableNum}*`;
        if (orderType === 'Delivery' && userAddress) headerInfo += `\n*ADDRESS: ${userAddress}*`;

        const waMsg = encodeURIComponent(`${headerInfo}\n\n${itemsListText}\n\nSubtotal: Rs ${foodTotal}${sc > 0 ? '\nS.C (7%): Rs ' + sc : ''}${delCharge > 0 ? '\nDelivery Charge: Rs ' + delCharge : ''}\n*Grand Total: Rs ${foodTotal + parseFloat(delCharge) + sc}*`);
        
        const waLink = `https://wa.me/923001450301?text=${waMsg}`;

        window.location.href = waLink;

        setTimeout(() => {
            cart = []; 
            updateCartBar(); 
            document.getElementById('overlay-screen').style.display = 'none'; 
            setScrollLock(false);
        }, 1000);
    }

    function renderFinalSummary(fee) {
        chkStep = 3; delCharge = parseFloat(fee) || 0;
        const foodTotal = cart.reduce((s, i) => s + (i.price * i.qty), 0);
        let sc = (orderType === "Dine-In") ? Math.round(foodTotal * 0.07) : 0;
        const grand = foodTotal + delCharge + sc;
        const summaryHTML = cart.map((i, idx) => `<div class="summary-item"><div class="summary-info"><b>${i.qty}x ${i.name}</b><br><small style="color:#666;">${i.note || ''}</small></div><div class="remove-item-btn btn-3d" onclick="removeItem(${idx})">üóëÔ∏è</div></div>`).join('');
        
        let summaryBubbleContent = `<b>ORDER SUMMARY</b>`;
        if (orderType === 'Delivery' && userAddress) summaryBubbleContent += `<br><small style="color:var(--red);">üìç Address: ${userAddress}</small>`;
        
        document.getElementById('checkout-content').innerHTML = `<div class="chat-bubble">${summaryBubbleContent}</div>${summaryHTML}<div class="chat-bubble">Subtotal: Rs ${foodTotal}${sc > 0 ? '<br>S.C: Rs '+sc : ''}${delCharge > 0 ? '<br>Delivery: Rs '+delCharge : ''}<br><hr>Total: <b>Rs ${grand}</b></div><button onclick="finalSubmitOrder()" class="confirm-btn btn-3d">ORDER VIA WHATSAPP</button>`;
    }

    function setInitialService(type) { playClick('thud'); orderType = type; document.getElementById('welcome-overlay').style.display = 'none'; setScrollLock(false); }
    document.getElementById('checkout-back-btn').onclick = function() { playClick('pop'); if(chkStep === 1) { document.getElementById('overlay-screen').style.display = 'none'; setScrollLock(false); } else renderServiceTypeStep(); };

    async function updateStatus(id, newStatus) { playClick('thud'); if(sb) await sb.from('kitchen_orders').update({ status: newStatus }).eq('id', id); renderKitchenOrders(); }
    
    async function clearReadyOrders() { 
        if(!confirm("Clear READY orders?")) return; 
        playClick('pop');
        if(!sb) return; 

        const { data: ready } = await sb.from('kitchen_orders').select('id').eq('status', 'READY'); 
        
        if(ready && ready.length > 0) { 
            const { error } = await sb.from('kitchen_orders').delete().in('id', ready.map(o => o.id)); 
            if (!error) renderKitchenOrders(); 
        } 
    }
    
    function openKitchenPanel() { document.getElementById('kitchen-panel-overlay').style.display = 'flex'; renderKitchenOrders(); if(!kitchenInterval) kitchenInterval = setInterval(renderKitchenOrders, 1000); setScrollLock(true); }
    function closeKitchenPanel() { document.getElementById('kitchen-panel-overlay').style.display = 'none'; if(kitchenInterval) { clearInterval(kitchenInterval); kitchenInterval = null; } setScrollLock(false); }
    
    async function renderKitchenOrders() {
        if(!sb) return;
        const { data: orders } = await sb.from('kitchen_orders').select('*').order('created_at', { ascending: false });
        const list = document.getElementById('kitchen-orders-list');
        list.innerHTML = (!orders || orders.length === 0) ? "<p style='text-align:center; color:#999; padding:20px;'>NO ACTIVE ORDERS</p>" : "";
        
        const now = new Date();
        const limitMs = 25 * 60 * 1000;
        const warningMs = 5 * 60 * 1000;
        let isAnyOrderLate = false;

        if(orders) orders.forEach((o) => {
            const createdAt = new Date(o.created_at);
            const elapsed = now - createdAt;
            const remaining = limitMs - elapsed;
            
            let timeLabel = "";
            let alertClass = "";
            
            if (o.status !== 'READY') {
                if (remaining <= 0) {
                    alertClass = "late";
                    const abs = Math.abs(remaining);
                    const mins = Math.floor(abs / 60000);
                    const secs = Math.floor((abs % 60000) / 1000);
                    timeLabel = `LATE: -${mins}:${secs.toString().padStart(2, '0')}`;
                    isAnyOrderLate = true;
                } else {
                    const mins = Math.floor(remaining / 60000);
                    const secs = Math.floor((remaining % 60000) / 1000);
                    timeLabel = `${mins}:${secs.toString().padStart(2, '0')}`;
                    if (remaining <= warningMs) alertClass = "warning";
                }
            }

            const card = document.createElement('div'); card.className = `kitchen-card status-${o.status.toLowerCase()} ${alertClass}`;
            card.innerHTML = `<span class="kitchen-badge kb-${o.status.toLowerCase()}">${o.status}</span><div style="font-weight:900; color:var(--red); font-size:18px;">${o.type.toUpperCase()} - ${o.location}</div><div class='order-timer'>${timeLabel}</div><div style="white-space:pre-wrap; font-weight:600; font-size:14px; background:#f9f9f9; padding:10px; border-radius:15px; margin-top:10px;">${o.items}</div><div style="display:flex; gap:10px; margin-top:15px;">${o.status === 'WAITING' ? `<button class="next-btn btn-3d" style="background:#007bff;" onclick="updateStatus('${o.id}', 'PREPARING')">PREPARING</button>` : ''}${o.status === 'PREPARING' ? `<button class="next-btn btn-3d" style="background:var(--wa-green);" onclick="updateStatus('${o.id}', 'READY')">MARK READY ‚úÖ</button>` : ''}</div>`;
            list.appendChild(card);
        });

        if(isAnyOrderLate) playClick('siren');
    }

    function renderPublicDeals() {
        const list = document.getElementById('deals-list'); list.innerHTML = '';
        dealsData.forEach(deal => {
            let bgUrl = imgMap["pizza"];
            if(deal.name.toLowerCase().includes('burger')) bgUrl = imgMap["burger"];
            list.innerHTML += `<div class="deal-card"><div class="deal-badge">${deal.badge || 'HOT'}</div><div class="deal-img-top" style="background-image: url('${bgUrl}?q=80&w=600&auto=format&fit=crop')"></div><div class="deal-info-box"><div class="deal-title">${deal.name}</div><span class="deal-desc">${deal.desc || ''}</span><span class="deal-price">Rs ${deal.price}</span><button class="next-btn btn-3d" style="background:var(--orange); box-shadow:0 6px 0px var(--dark-orange); margin-bottom:0;" onclick='openOrderFlow(${JSON.stringify(deal)})'>ADD TO BAG</button></div></div>`;
        });
    }

    function renderPublicMenu(filterText = "") {
        const mC = document.getElementById('menu-container'); 
        mC.innerHTML = "";
        const search = filterText.toLowerCase();

        for (let cat in menuData) {
            // FIX: HIDE Pan/Premium from main menu rendering
            if (cat === "Pan/Premium") continue;

            const filteredItems = menuData[cat].filter(item => 
                item.name.toLowerCase().includes(search) || cat.toLowerCase().includes(search)
            );

            if (filteredItems.length > 0) {
                let title = document.createElement('div'); 
                title.className = 'section-title'; 
                title.innerText = cat; 
                title.id = "cat-" + cat.replace(/\s+/g, '-'); 
                mC.appendChild(title);

                let grid = document.createElement('div'); 
                grid.className = 'grid';
                filteredItems.forEach(item => {
                    const itemName = item.name.toLowerCase(); 
                    let fBg = imgMap["pizza"];
                    for (let key in imgMap) if (itemName.includes(key)) fBg = imgMap[key];
                    
                    let b = document.createElement('div'); 
                    b.className = 'btn btn-3d'; 
                    b.style.backgroundImage = `url('${fBg}?q=80&w=400&auto=format&fit=crop')`;
                    b.innerHTML = `<div class="item-label-box"><div>${item.name}</div><div class="price-tag">${typeof item.price === 'object' ? 'PICK SIZE' : 'Rs '+item.price}</div></div>`;
                    b.onclick = () => openOrderFlow(item); 
                    grid.appendChild(b);
                });
                mC.appendChild(grid);
            }
        }
        
        if (mC.innerHTML === "") {
            mC.innerHTML = "<p style='text-align:center; padding:50px; color:#999; font-weight:900;'>NO ITEMS FOUND üçï</p>";
        }
    }

    function renderCategoryBar() {
        const bar = document.getElementById('category-bar');
        bar.innerHTML = "";
        for (let cat in menuData) {
            if (cat === "Pan/Premium") continue; 
            const pill = document.createElement('div');
            pill.className = "cat-pill";
            pill.innerText = cat;
            pill.onclick = () => {
                playClick('pop');
                document.getElementById('menuSearch').value = "";
                renderPublicMenu();
                const target = document.getElementById("cat-" + cat.replace(/\s+/g, '-'));
                if(target) target.scrollIntoView();
                document.querySelectorAll('.cat-pill').forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
            };
            bar.appendChild(pill);
        }
    }

    function handleSearch(val) {
        renderPublicMenu(val);
        if (val === "") {
            document.querySelectorAll('.cat-pill').forEach(p => p.classList.remove('active'));
        }
    }

    renderPublicMenu(); 
    renderPublicDeals();
    renderCategoryBar();

    function setupRealtimeNotifications() {
        if(!sb) return;
        sb.channel('custom-all-channel')
        .on('postgres_changes', 
            { event: 'INSERT', schema: 'public', table: 'kitchen_orders' }, 
            (payload) => {
                if (Notification.permission === "granted") {
                    new Notification("üçï NEW ORDER RECEIVED!", {
                        body: `New ${payload.new.type} order at ${payload.new.location}`,
                        icon: "https://cdn-icons-png.flaticon.com/512/5973/5973307.png"
                    });
                }
                if(document.getElementById('kitchen-panel-overlay').style.display === 'flex') {
                    renderKitchenOrders();
                }
            }
        )
        .subscribe();
    }

    let deferredPrompt;
    let secretClickCount = 0;

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
    });

    function handleSecretClick() {
        secretClickCount++;
        if(secretClickCount === 5) {
            secretClickCount = 0;
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choice) => {
                    deferredPrompt = null;
                });
            } else {
                alert("Installation already complete or not supported on this device/browser.");
            }
        }
        setTimeout(() => { secretClickCount = 0; }, 2000);
    }

    if ('serviceWorker' in navigator) {
        const sw = `self.addEventListener('fetch', e => e.respondWith(fetch(e.request)));`;
        const blob = new Blob([sw], { type: 'text/javascript' });
        navigator.serviceWorker.register(URL.createObjectURL(blob));
    }
</script>
</body>
</html>
