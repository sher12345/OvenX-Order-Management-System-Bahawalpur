<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- PWA META TAGS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#8b0000">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"Oven X Bahawalpur","short_name":"OvenX BWP","start_url":".","display":"standalone","background_color":"#8b0000","theme_color":"#8b0000","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/5973/5973307.png","sizes":"512x512","type":"image/png","purpose":"any"}]}'>

    <title>Oven X Bahawalpur - Official Order System</title>
    <style>
        :root { 
            --red: #8b0000; 
            --dark-red: #5e0000;
            --orange: #f37021; 
            --dark-orange: #b34e12;
            --white: #ffffff;
            --bg-body: #fff9f5; 
            --radius-bubble: 25px;
            --wa-green: #25D366;
            --wa-dark: #1a9648;
            --gold: #d4af37;
            --gold-gradient: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
        }
        * { -webkit-tap-highlight-color: transparent; outline: none; touch-action: manipulation; box-sizing: border-box; }
        body.modal-active { overflow: hidden; height: 100vh; }
        body { 
            background: var(--bg-body) !important; 
            color: #333 !important; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding-bottom: 0; overflow-x: hidden;
        }
        #top-sticky-container {
            position: sticky; top: 0; z-index: 2000;
            display: none; flex-direction: column;
            background: var(--bg-body);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-15px);}
            60% {transform: translateY(-7px);}
        }
        @keyframes aggressive-shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .bouncing-logo { animation: bounce 2s infinite; display: inline-block; }
        .btn-3d { transition: transform 0.1s, box-shadow 0.1s; cursor: pointer; border: none; position: relative; user-select: none; }
        .btn-3d:active { transform: translateY(4px) !important; box-shadow: 0 2px 0px rgba(0,0,0,0.2) !important; }
        
        #gateway-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #2c0000, #000000);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 4000; text-align: center; color: white; overflow-y: auto; padding: 20px 0;
        }

        /* --- LOYALTY CARD CSS --- */
        .loyalty-card { 
            background: rgba(10, 10, 10, 0.95); 
            border-radius: 35px; padding: 25px 15px; margin: 0 0 25px; 
            border: 2px solid var(--gold); width: 90%; max-width: 380px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.9), inset 0 0 20px rgba(212,175,55,0.1);
            position: relative;
        }
        .loyalty-header { display: flex; justify-content: space-between; align-items: center; padding: 0 10px 15px; }
        .gold-label { 
            background: var(--gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            font-weight: 900; text-transform: uppercase; letter-spacing: 2px; font-size: 15px;
        }
        .stamp-grid-container { display: flex; flex-direction: column; gap: 15px; align-items: center; width: 100%; }
        .stamp-row { display: flex; justify-content: center; gap: 8px; width: 100%; }
        .stamp-circle { 
            width: 42px; height: 42px; border-radius: 50%; 
            border: 2px dashed rgba(212, 175, 55, 0.4); 
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: 900; color: rgba(212, 175, 55, 0.3);
            background: rgba(255,255,255,0.02); transition: 0.4s;
        }
        .stamp-circle.filled { 
            background: var(--gold-gradient); border: 2px solid #fff; color: #000;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.8); transform: scale(1.1); border-style: solid;
        }
        .loyalty-footer { color: #ccc; font-size: 11px; margin-top: 20px; font-weight: 700; line-height: 1.4; padding: 0 10px; }
        .btn-gold { background: var(--gold-gradient); color: #000; font-weight: 900; box-shadow: 0 6px 0px #866619; margin-bottom: 25px; width: 85%; max-width: 340px; }

        .gateway-logo { font-size: 60px; font-weight: 900; margin-bottom: 5px; letter-spacing: -2px; }
        .gateway-logo span { color: var(--orange); }
        #gateway-table-note { background: var(--orange); color: white; padding: 12px 25px; border-radius: 50px; font-size: 16px; font-weight: bold; margin-bottom: 20px; display: none; box-shadow: 0 8px 20px rgba(243, 112, 33, 0.4); }
        .gateway-options { display: flex; flex-direction: column; gap: 15px; width: 85%; max-width: 340px; }
        .gate-btn { padding: 20px; border-radius: var(--radius-bubble); font-size: 16px; font-weight: 800; text-transform: uppercase; }
        .btn-red { background: var(--red); color: white; box-shadow: 0 6px 0px var(--dark-red); }
        .btn-orange { background: var(--orange); color: white; box-shadow: 0 6px 0px var(--dark-orange); }
        .btn-outline { background: transparent; color: white; border: 3px solid white; box-shadow: 0 6px 0px rgba(255,255,255,0.2); }
        
        header { background: var(--red); color: white; padding: 12px 15px; text-align: center; border-bottom: 6px solid var(--orange); display: flex; justify-content: space-between; align-items: center; }
        .header-back-btn { background: var(--orange); color: white; border: none; padding: 8px 15px; border-radius: 15px; font-weight: 900; font-size: 12px; box-shadow: 0 3px 0px var(--dark-orange); }
        .logo { font-size: 24px; font-weight: 900; margin: 0; text-transform: uppercase; flex-grow: 1;}
        .logo span { color: var(--orange); }
        .tab-bar { background: #fff; padding: 10px; display: flex; justify-content: center; gap: 10px; border-bottom: 2px solid #eee; }
        .tab-item { background: #f0f0f0; padding: 12px; border-radius: 20px; font-weight: 800; font-size: 13px; flex: 1; text-align: center; color: #777; transition: 0.2s; }
        .tab-item.active { background: var(--red); color: white; box-shadow: 0 5px 15px rgba(139, 0, 0, 0.3); }

        .menu-controls { background: white; padding: 10px 0; border-bottom: 2px solid #eee; }
        .search-box-wrap { padding: 0 15px 10px; }
        .search-input { width: 100%; border: 3px solid #f0f0f0; border-radius: 50px; padding: 12px 20px; font-size: 14px; font-weight: 700; box-sizing: border-box; }
        .search-input:focus { border-color: var(--orange); }
        .category-scroller { display: flex; overflow-x: auto; white-space: nowrap; gap: 10px; padding: 0 15px; scroll-behavior: smooth; }
        .category-scroller::-webkit-scrollbar { display: none; }
        .cat-pill { background: #f0f0f0; color: #777; padding: 8px 18px; border-radius: 50px; font-size: 12px; font-weight: 900; cursor: pointer; transition: 0.2s; flex-shrink: 0; border: 2px solid transparent; }
        .cat-pill.active { background: var(--orange); color: white; box-shadow: 0 4px 10px rgba(243, 112, 33, 0.3); }

        .container, .deals-container { max-width: 600px; margin: auto; padding: 10px 15px 180px 15px; }
        .section-title { font-weight: 900; color: var(--red); margin: 30px 0 15px; font-size: 26px; text-transform: uppercase; display: inline-block; border-bottom: 5px solid var(--orange); padding-bottom: 2px; scroll-margin-top: 180px; }
        .deal-card { background: white; border-radius: 35px; overflow: hidden; margin-bottom: 30px; box-shadow: 0 10px 0px #eee; position: relative; border: 3px solid #fff; }
        .deal-img-top { height: 180px; background-size: cover; background-position: center; border-bottom: 2px solid #f9f9f9; }
        .deal-info-box { padding: 20px; text-align: center; }
        .deal-badge { position: absolute; top: 12px; left: 12px; background: var(--orange); color: white; padding: 6px 14px; border-radius: 20px; font-size: 10px; font-weight: 900; box-shadow: 0 4px 0px var(--dark-orange); z-index: 5; }
        .deal-title { font-weight: 900; color: var(--red); font-size: 22px; text-transform: uppercase; margin-bottom: 5px; }
        .deal-desc { font-size: 13px; color: #666; font-weight: 600; line-height: 1.3; margin-bottom: 15px; display: block;}
        .deal-price { color: var(--orange); font-weight: 900; font-size: 24px; display: block; margin-bottom: 15px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .btn { background-color: #eee; background-size: cover; background-position: center; border: 3px solid #fff; border-radius: 25px; overflow: hidden; display: flex; flex-direction: column; justify-content: flex-end; min-height: 160px; box-shadow: 0 6px 0px #ddd; position: relative; }
        .item-label-box { background: rgba(255, 255, 255, 0.98); padding: 12px; width: 100%; box-sizing: border-box; text-align: center; border-top: 1px solid rgba(0,0,0,0.05); }
        .price-tag { color: var(--orange); font-weight: 900; font-size: 13px; margin-top: 4px; }
        .size-feedback { background: var(--orange) !important; color: white !important; box-shadow: 0 4px 0px var(--dark-orange) !important; }
        #cart-bar { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 450px; background: var(--red); color: white; padding: 12px 20px; border-radius: 50px; display: none; justify-content: space-between; align-items: center; z-index: 1000; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4); border: 2px solid rgba(255,255,255,0.1); }
        .checkout-btn { background: var(--orange); padding: 12px 25px; border-radius: 30px; color: white; font-weight: 900; font-size: 15px; box-shadow: 0 5px 0px var(--dark-orange); }
        
        #modal-overlay, #welcome-overlay, #flavor-overlay, #size-overlay, #admin-login-overlay, #tracking-overlay, #upsell-overlay, #loyalty-setup-overlay { 
            position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); display:none; justify-content:center; align-items:center; z-index: 9000; backdrop-filter: blur(8px); 
        }

        /* FIXED MANUAL ORDER Z-INDEX (MUST BE HIGHER THAN KITCHEN PANEL) */
        #manual-order-overlay { 
            position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); display:none; justify-content:center; align-items:center; z-index: 9999; backdrop-filter: blur(8px); 
        }
        
        /* DELIVERY CALCULATOR OVERLAY */
        #delivery-calc-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); display:none; justify-content:center; align-items:center; z-index: 10000; backdrop-filter: blur(10px);
        }
        .delivery-calc-modal {
            background: white; border-radius: 35px; width: 95%; max-width: 500px; height: 90vh; display: flex; flex-direction: column; overflow: hidden; position: relative;
        }
        .calc-header { padding: 20px; border-bottom: 2px solid #eee; display: flex; justify-content: space-between; align-items: center; background: var(--red); color: white; }
        .calc-content { flex: 1; overflow-y: auto; padding: 20px; }
        .calc-footer { padding: 20px; border-top: 2px solid #eee; background: #f9f9f9; }
        
        #overlay-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 3000; display: none; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .modal { background: var(--white); padding: 30px; border-radius: 35px; width: 85%; max-width: 380px; text-align: center; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        
        /* Gold Club Specific Modals */
        .modal-gold { background: #0a0a0a; border: 2px solid var(--gold); color: white; overflow: hidden !important; }
        .premium-input { width: 100%; padding: 16px; border-radius: 15px; background: #1a1a1a; border: 1.5px solid rgba(212,175,55,0.3); color: white; margin-top: 12px; font-size: 16px; }

        .qty-btns { display: flex; justify-content: center; gap: 10px; margin: 20px 0; }
        .qty-btn { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #eee; background: white; font-weight: 900; font-size: 16px; }
        .qty-btn.active { background: var(--red); color: white; border-color: var(--red); box-shadow: 0 4px 0px var(--dark-red); }
        textarea, .big-input { width: 100%; border-radius: 20px; border: 3px solid #f0f0f0; padding: 18px; margin-top: 15px; font-size: 16px; box-sizing: border-box; }
        .next-btn { padding: 18px; border-radius: 20px; border: none; font-weight: 900; width: 100%; margin-bottom: 12px; color: white; display: block; cursor: pointer; }
        .confirm-btn { background: var(--wa-green); color: white; padding: 20px; border-radius: 25px; font-weight: 900; width: 100%; margin-top: 20px; font-size: 20px; box-shadow: 0 6px 0px var(--wa-dark); }
        .summary-item { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px 20px; border-radius: 25px; margin-bottom: 12px; border: 1px solid #eee; text-align: left; }
        .remove-item-btn { background: #ff4444; color: white; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 15px; font-size: 18px; box-shadow: 0 4px 0px #900; margin-left: 15px; }

        /* KITCHEN PANEL MODAL CSS */
        #kitchen-panel-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 9500; backdrop-filter: blur(10px); }
        .kitchen-modal { background: var(--white); border-radius: 35px; width: 98%; max-width: 1400px; height: 95vh; display: flex; flex-direction: column; overflow: hidden; }
        .kitchen-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .kitchen-content-wrapper { display: flex; flex: 1; overflow: hidden; }
        #kitchen-orders-list { flex: 2; overflow-y: auto; padding: 20px; background: #f9f9f9; }
        #rider-audit-sidebar { flex: 1; background: white; border-left: 4px solid #eee; padding: 20px; display: none; flex-direction: column; overflow-y: auto; }
        
        /* DELIVERY HISTORY SIDEBAR */
        #delivery-history-sidebar { 
            flex: 1; background: white; border-left: 4px solid var(--orange); padding: 20px; display: none; flex-direction: column; overflow-y: auto; 
        }
        .delivery-history-card {
            background: linear-gradient(135deg, #fff9f5 0%, #ffffff 100%);
            border: 2px solid var(--orange);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
            box-shadow: 0 4px 15px rgba(243, 112, 33, 0.1);
        }
        .delivery-history-card .distance-badge {
            position: absolute; top: 10px; right: 10px;
            background: var(--red); color: white;
            padding: 5px 12px; border-radius: 15px;
            font-size: 11px; font-weight: 900;
        }
        .delivery-history-card .loc-text {
            font-size: 13px; font-weight: 700; color: #333;
            margin-bottom: 8px; padding-right: 60px;
        }
        .delivery-history-card .meta-row {
            display: flex; justify-content: space-between;
            font-size: 11px; color: #666;
            margin-top: 8px; padding-top: 8px;
            border-top: 1px dashed #ddd;
        }
        .delivery-history-card .cost-highlight {
            color: var(--red); font-weight: 900; font-size: 16px;
        }

        .kitchen-card { background: white; padding: 25px; border-radius: 30px; margin-bottom: 20px; border-left: 12px solid var(--orange); text-align: left; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: 0.3s; }
        .kitchen-card.status-preparing { border-left-color: #007bff; }
        .kitchen-card.status-ready { border-left-color: var(--wa-green); opacity: 0.6; }
        .kitchen-card.warning { box-shadow: 0 0 25px #ffd700; border-left-color: #ffd700 !important; animation: bounce 2s infinite; }
        .kitchen-card.late { background: #fff1f1; border-left-color: #ff0000 !important; box-shadow: 0 0 35px #ff0000; animation: aggressive-shake 0.2s infinite; border: 2px solid red; }
        .order-timer { font-size: 22px; font-weight: 900; color: #444; margin-top: 5px; font-family: monospace; }
        .kitchen-badge { position: absolute; top: 15px; right: 15px; font-size: 11px; font-weight: 900; padding: 5px 12px; border-radius: 10px; text-transform: uppercase; }
        .kb-waiting { background: #fff3e0; color: var(--orange); }
        .kb-preparing { background: #e3f2fd; color: #007bff; }
        .kb-ready { background: #e8f5e9; color: var(--wa-green); }

        .price-box { background: #fff9e6; padding: 15px; border-radius: 18px; margin-top: 15px; display: flex; justify-content: space-between; font-weight: 900; border: 1px solid #ffe082; }
        .rider-box { margin-top: 15px; padding: 15px; background: #fdfdfd; border: 2px dashed #ddd; border-radius: 20px; }
        .rider-btn { padding: 10px 15px; border-radius: 12px; border: 2px solid #eee; background: white; font-size: 12px; font-weight: 800; cursor: pointer; margin: 3px; }
        .rider-btn.selected { background: var(--wa-green) !important; color: white !important; border-color: var(--wa-dark) !important; box-shadow: 0 4px 0px var(--wa-dark); }
        
        .k-tab { flex: 1; padding: 15px; border-radius: 15px; background: #eee; font-weight: 900; text-align: center; cursor: pointer; }
        .k-tab.active { background: var(--red); color: white; box-shadow: 0 4px 10px rgba(139,0,0,0.3); }

        /* ADMIN ACTION BUTTONS STYLING */
        .admin-actions { display: flex; flex-wrap: wrap; gap: 8px; margin: 12px 0 8px; font-size: 11px; }
        .btn-action { padding: 6px 10px; border-radius: 10px; font-weight: 800; font-size: 11px; border: none; color: white; cursor: pointer; flex: 1; min-width: 70px; text-align: center; text-transform: uppercase; }
        .btn-void-item   { background: #6c757d; }
        .btn-recall      { background: #0d6efd; }
        .btn-table       { background: #fd7e14; }
        .btn-void-order  { background: #dc3545; }
        .btn-print-front { background: #198754; box-shadow: 0 3px 0 #115c3a; }
        .btn-print-kitchen { background: #6f42c1; box-shadow: 0 3px 0 #4e2e88; }
        .btn-send-cc {
    background: #25D366 !important; /* WhatsApp green */
    color: white !important;
    box-shadow: 0 4px 0 #128C7E !important;
    font-size: 12px !important;
    padding: 8px 15px !important;
    border-radius: 12px !important;
    border: none !important;
    cursor: pointer !important;
    transition: all 0.2s !important;
    display: flex !important;
    align-items: center !important;
    gap: 5px !important;
}

.btn-send-cc:hover:not(:disabled) {
    transform: translateY(-2px) !important;
    box-shadow: 0 6px 0 #128C7E !important;
}

.btn-send-cc:active:not(:disabled) {
    transform: translateY(2px) !important;
    box-shadow: 0 2px 0 #128C7E !important;
}

.btn-send-cc:disabled,
.btn-send-cc.sent {
    background: #28a745 !important; /* Success green */
    box-shadow: 0 3px 0 #1e7e34 !important;
    cursor: not-allowed !important;
    opacity: 0.9 !important;
}

/* Toast notification */
.kitchen-toast {
    font-family: 'Segoe UI', sans-serif;
    backdrop-filter: blur(10px);
}
        .delivery-center-wrap { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; margin: 20px 0; }
        .delivery-cta { background: #fff; border: 4px solid var(--orange); padding: 30px 20px; border-radius: 35px; text-align: center; cursor: pointer; box-shadow: 0 10px 0px var(--dark-orange); width: 92%; max-width: 340px; box-sizing: border-box; }
        .chat-bubble { background: white; padding: 20px; border-radius: 25px; margin-bottom: 20px; border: 2px solid #eee; text-align: left; }
        #secret-pwa-button { position: fixed; bottom: 0; right: 0; width: 45px; height: 45px; z-index: 9999; background: transparent; }

        /* DELIVERY CALCULATOR STYLES */
        .calc-location-card {
            background: linear-gradient(135deg, #fff9f5 0%, #ffffff 100%);
            border: 3px dashed var(--orange);
            border-radius: 25px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }
        .calc-pulse-ring {
            width: 80px; height: 80px;
            background: rgba(243, 112, 33, 0.1);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 20px;
            position: relative;
        }
        .calc-pulse-ring::before {
            content: ''; position: absolute;
            width: 100%; height: 100%;
            border-radius: 50%;
            background: rgba(243, 112, 33, 0.3);
            animation: pulse-ring 2s infinite;
        }
        .calc-result-box {
            background: linear-gradient(135deg, var(--red) 0%, var(--dark-red) 100%);
            color: white;
            padding: 25px;
            border-radius: 25px;
            margin-top: 20px;
            display: none;
        }
        .calc-distance-visual {
            background: #f0f0f0;
            padding: 20px;
            border-radius: 20px;
            margin: 20px 0;
            position: relative;
            height: 100px;
            display: flex; align-items: center;
        }
        .calc-line {
            height: 4px;
            background: linear-gradient(90deg, var(--red) 0%, var(--orange) 100%);
            flex: 1;
            position: relative;
            border-radius: 2px;
        }
        .calc-dot {
            width: 20px; height: 20px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            position: relative; z-index: 2;
        }
        .calc-dot.start { background: var(--red); }
        .calc-dot.end { background: var(--orange); }
        
        /* TRACKER UI */
        .tracking-status-icon { font-size: 80px; margin-bottom: 20px; display: block; animation: bounce 2s infinite; }
        .tracking-step { opacity: 0.3; margin: 15px 0; font-weight: 900; font-size: 18px; transition: 0.5s; display: flex; align-items: center; gap: 10px; }
        .tracking-step.active { opacity: 1; color: var(--orange); transform: scale(1.05); }

        /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
           FIXED PRINT STYLES ‚Äì OvenX Branded Receipt
        ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #print-area { display: none; }
        @media print {
            body > *:not(#print-area) { display: none !important; }
            #print-area {
                display: block !important;
                position: fixed !important;
                top: 0; left: 0;
                width: 72mm; max-width: 72mm;
                min-height: 0;
                color: black !important;
                background: white !important;
                font-family: 'Courier New', Courier, monospace;
                font-size: 15px;
                line-height: 1.28;
                padding: 2mm 1.5mm 1mm 1.5mm;
                margin: 0;
                box-sizing: border-box;
                overflow: hidden;
            }
            @page { size: 72mm auto; margin: 0; }
            h2 { margin: 1mm 0 1mm 0; font-size: 18px; text-align: center; font-weight: bold; letter-spacing: 0.5px; }
            .branch-info { font-size: 13px; text-align: center; line-height: 1.3; margin: 0 0 2mm 0; }
            .print-line { border-bottom: 1px dashed #000; margin: 2mm 0; width: 100%; }
            .items { white-space: pre-wrap; text-align: left; font-size: 15px; line-height: 1.35; margin: 2mm 0; }
            .total-line { font-size: 16px; font-weight: bold; text-align: right; margin: 1mm 0; }
            .thanks { margin: 4mm 0 2mm 0; font-size: 13px; text-align: center; line-height: 1.3; }
            .logo-print-img { 
                width: 45%; 
                max-width: 130px; 
                height: auto; 
                margin: 1mm auto 2mm auto; 
                display: block; 
            }
            .charges-line { font-size: 15px; text-align: right; margin: 1mm 0; font-weight: bold; }
            body, html { height: auto !important; margin: 0 !important; padding: 0 !important; }
        }
    </style>
</head>
<body>

<div id="secret-pwa-button" onclick="handleSecretClick()"></div>

<!-- Hidden print container -->
<div id="print-area"></div>

<div id="gateway-screen">
    <div class="bouncing-logo"><p class="gateway-logo">OVEN <span>X</span></p></div>
    
    <div id="gateway-table-note">üéâ WELCOME! TABLE <span id="gateway-table-id"></span> üéâ</div>

    <!-- OVEN X CLUB CARD -->
    <div id="loyalty-display" style="display:none;" class="loyalty-card">
        <div class="loyalty-header">
            <span class="gold-label">OVEN X CLUB</span>
            <span id="club-member-name" style="color:white; font-weight:900;"></span>
        </div>
        <div class="stamp-grid-container">
            <div class="stamp-row" id="stamp-row-1"></div>
            <div class="stamp-row" id="stamp-row-2"></div>
        </div>
        <p id="loyalty-msg" class="loyalty-footer"></p>
    </div>
    
    <button id="join-club-btn" onclick="openLoyaltySetup()" class="gate-btn btn-gold btn-3d">üëë Join Oven X Club & Win Free Meals!</button>

    <div class="gateway-options">
        <button class="gate-btn btn-3d btn-orange" onclick="enterApp('deals')">üî• Best Deals!</button>
        <button class="gate-btn btn-3d btn-red" onclick="enterApp('menu')">üìñ Full Menu</button>
        <button class="gate-btn btn-3d btn-outline" onclick="openAdminLogin()">üë®‚Äçüç≥ KITCHEN PANEL</button>
    </div>
</div>

<div id="top-sticky-container">
    <header id="main-header">
        <button class="header-back-btn btn-3d" onclick="exitToGateway()">‚Üê HOME</button>
        <p class="logo">OVEN <span>X</span> <br><small id="header-table-indicator" style="font-size:10px; font-weight:bold;"></small></p>
        <div style="width:60px;"></div>
    </header>
    <div class="tab-bar" id="nav-tabs">
        <div class="tab-item active" id="tab-menu" onclick="switchTab('menu')">FULL MENU</div>
        <div class="tab-item" id="tab-deals" onclick="switchTab('deals')">HOT DEALS</div>
    </div>
    <div class="menu-controls" id="menu-controls">
        <div class="search-box-wrap">
            <input type="text" id="menuSearch" class="search-input" placeholder="üîç Search food..." oninput="handleSearch(this.value)">
        </div>
        <div class="category-scroller" id="category-bar"></div>
    </div>
</div>

<div id="deals-container" class="deals-container"><div id="deals-list"></div></div>
<div class="container" id="menu-container" style="display:none;"></div>

<div id="cart-bar">
    <div><span id="cart-count" style="font-size:11px; font-weight:900; color:var(--orange);">ITEMS: 0</span><br><span id="cart-total" style="font-size:20px; font-weight:900;">Rs 0</span></div>
    <div class="checkout-btn btn-3d" onclick="startCheckout()">CHECKOUT ‚Üí</div>
</div>

<!-- MANUAL ORDER MODAL -->
<div id="manual-order-overlay">
    <div class="modal">
        <h2 style="color:var(--red); font-weight:900;">Manual Order üìù</h2>
        <select id="man-type" class="big-input">
            <option value="Dine-In">Dine-In</option>
            <option value="Takeaway">Takeaway</option>
            <option value="Delivery">Delivery</option>
        </select>
        <input type="text" id="man-loc" placeholder="Table # or Address" class="big-input">
        <textarea id="man-items" placeholder="Items List (e.g. 1x Pizza, 2x Zinger)" class="big-input" style="height:100px;"></textarea>
        <div style="display:flex; gap:10px;">
           <input type="number" id="man-sub" placeholder="Subtotal" class="big-input">
           <input type="number" id="man-fee" placeholder="Del. Fee" class="big-input">
        </div>
        <button class="confirm-btn btn-3d" style="background:var(--red);" onclick="saveManualOrder()">SAVE TO KITCHEN</button>
        <button onclick="document.getElementById('manual-order-overlay').style.display='none'; setScrollLock(false);" style="margin-top:15px; border:none; background:none; color:gray; font-weight:bold;">CANCEL</button>
    </div>
</div>

<!-- DELIVERY CALCULATOR OVERLAY -->
<div id="delivery-calc-overlay">
    <div class="delivery-calc-modal">
        <div class="calc-header">
            <h2 style="margin:0; font-weight:900;">üöö Delivery Calculator</h2>
            <button onclick="closeDeliveryCalc()" style="background:white; color:var(--red); border:none; padding:8px 15px; border-radius:10px; font-weight:900;">‚úï</button>
        </div>
        <div class="calc-content" id="calc-content-area">
            <!-- Location Permission State -->
            <div id="calc-permission-state">
                <div class="calc-location-card">
                    <div class="calc-pulse-ring">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#f37021" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                    </div>
                    <h3 style="color:var(--red); margin-bottom:10px;">Allow Location Access</h3>
                    <p style="color:#666; font-size:14px; margin-bottom:20px;">We need your location to calculate accurate delivery charges from OvenX Bahawalpur Kitchen.</p>
                    <button onclick="requestCalcLocation()" class="btn-3d" style="background:var(--red); color:white; padding:15px 30px; border-radius:15px; font-weight:900; width:100%; box-shadow:0 6px 0px var(--dark-red);">
                        ALLOW LOCATION
                    </button>
                </div>
            </div>
            
            <!-- Loading State -->
            <div id="calc-loading-state" style="display:none; text-align:center; padding:40px;">
                <div style="width:50px; height:50px; border:4px solid #f0f0f0; border-top-color:var(--red); border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 20px;"></div>
                <p style="font-weight:900; color:var(--red);">Calculating road distance...</p>
                <p style="font-size:12px; color:#999;">Getting precise GPS coordinates</p>
            </div>
            
            <!-- Result State -->
            <div id="calc-result-state" style="display:none;">
                <div class="calc-distance-visual">
                    <div class="calc-dot start"></div>
                    <div class="calc-line"></div>
                    <div class="calc-dot end"></div>
                </div>
                
                <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                    <div style="text-align:left;">
                        <p style="font-size:11px; color:#999; font-weight:900; margin:0;">FROM</p>
                        <p style="font-weight:900; color:var(--red); margin:5px 0;">OvenX Bahawalpur</p>
                    </div>
                    <div style="text-align:right;">
                        <p style="font-size:11px; color:#999; font-weight:900; margin:0;">TO</p>
                        <p style="font-weight:900; color:var(--orange); margin:5px 0;">Your Location</p>
                    </div>
                </div>
                
                <div class="calc-result-box" id="calc-result-box">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <div>
                            <p style="font-size:11px; opacity:0.8; margin:0;">ROUND TRIP DELIVERY</p>
                            <div style="display:flex; align-items:baseline; gap:10px;">
                                <span id="calc-total-cost" style="font-size:48px; font-weight:900;">0</span>
                                <span style="font-size:20px; opacity:0.8;">PKR</span>
                            </div>
                        </div>
                        <div style="background:rgba(255,255,255,0.2); padding:8px 15px; border-radius:10px;">
                            <p style="font-size:11px; margin:0;">Rs. 12/km</p>
                        </div>
                    </div>
                    
                    <div style="border-top:1px solid rgba(255,255,255,0.2); padding-top:15px; font-size:13px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                            <span style="opacity:0.8;">One Way Distance</span>
                            <span id="calc-one-way" style="font-weight:900;">0.0 km</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                            <span style="opacity:0.8;">Round Trip</span>
                            <span id="calc-round-trip" style="font-weight:900;">0.0 km</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; font-size:11px; opacity:0.6;">
                            <span>Straight-line distance</span>
                            <span id="calc-straight-line">0.0 km</span>
                        </div>
                    </div>
                </div>
                
                <div style="background:#e8f5e9; border:2px solid #4caf50; border-radius:15px; padding:15px; margin-top:20px; display:flex; align-items:center; gap:10px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#4caf50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    <div>
                        <p style="font-weight:900; color:#2e7d32; margin:0;">Price Confirmed!</p>
                        <p style="font-size:12px; color:#555; margin:5px 0 0;">Adding to your order automatically...</p>
                    </div>
                </div>
            </div>
            
            <!-- Error State -->
            <div id="calc-error-state" style="display:none; text-align:center; padding:30px;">
                <div style="width:60px; height:60px; background:#ffebee; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="#c62828" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" x2="9" y1="9" y2="15"></line>
                        <line x1="9" x2="15" y1="9" y2="15"></line>
                    </svg>
                </div>
                <h3 style="color:#c62828; margin-bottom:10px;">Location Error</h3>
                <p id="calc-error-msg" style="color:#666; font-size:14px; margin-bottom:20px;">Unable to get your location.</p>
                <button onclick="requestCalcLocation()" class="btn-3d" style="background:var(--red); color:white; padding:12px 25px; border-radius:12px; font-weight:900;">TRY AGAIN</button>
            </div>
        </div>
    </div>
</div>

<!-- CLUB SETUP MODAL -->
<div id="loyalty-setup-overlay">
    <div class="modal modal-gold">
        <h2 class="gold-label">ACTIVATE CLUB CARD üëë</h2>
        <p style="color:#aaa; font-size:13px; margin:15px 0;">Collect 10 stamps (Order Rs 1000+) to win a mystery free meal!</p>
        <input type="text" id="clubName" placeholder="Full Name" class="premium-input">
        <input type="number" id="clubPhone" placeholder="WhatsApp Number" class="premium-input">
        <button class="gate-btn btn-gold btn-3d" style="width:100%; margin-top:20px;" onclick="saveClubProfile()">ACTIVATE NOW üöÄ</button>
        <button onclick="document.getElementById('loyalty-setup-overlay').style.display='none'; setScrollLock(false);" style="margin-top:15px; color:#666; font-weight:bold; background:none; border:none;">CANCEL</button>
    </div>
</div>

<div id="admin-login-overlay">
    <div class="modal">
        <h2 style="color:var(--red); font-weight:900;">Kitchen Access</h2>
        <input type="text" id="adminPassword" placeholder="Secret Code" class="big-input" oninput="handlePassInput(this)" style="text-align:center; letter-spacing:4px; font-size:22px;">
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="next-btn btn-3d" style="background:#888;" onclick="closeAdminLogin()">BACK</button>
            <button class="next-btn btn-3d" style="background:var(--red);" onclick="verifyAdmin()">UNLOCK</button>
        </div>
    </div>
</div>

<!-- KITCHEN PANEL MODAL -->
<div id="kitchen-panel-overlay">
    <div class="kitchen-modal">
        <div class="kitchen-header">
            <h2 style="margin:0; color:var(--red); font-weight:900;">LIVE KITCHEN</h2>
            <div style="display:flex; gap:10px;">
                <button class="header-back-btn btn-3d" style="background:var(--wa-green);" onclick="downloadCustomerData()">CUSTOMERS üì•</button>
                <button class="header-back-btn btn-3d" style="background:#444;" onclick="openManualOrderModal()">MANUAL ORDER ‚ûï</button>
                <button class="header-back-btn btn-3d" onclick="closeKitchenPanel()">EXIT</button>
            </div>
        </div>
        <div style="display:flex; gap:10px; padding:15px; background:white; border-bottom:1px solid #eee;">
            <div class="k-tab active" id="k-tab-all" onclick="setKitchenFilter('ALL')">ALL ORDERS</div>
            <div class="k-tab" id="k-tab-del" onclick="setKitchenFilter('DELIVERY')">DELIVERY ONLY üöö</div>
            <div class="k-tab" id="k-tab-calc" onclick="setKitchenFilter('CALC_HISTORY')" style="background:var(--orange); color:white;">üìç DELIVERY CALCS</div>
        </div>
        <div class="kitchen-content-wrapper">
            <div id="kitchen-orders-list"></div>
            <div id="rider-audit-sidebar">
                <h3 style="margin-top:0; color:var(--red);">Rider Audit</h3>
                <div id="rider-audit-selection" style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:20px;"></div>
                <div id="audit-result-box" style="display:none;">
                    <div class="audit-card">
                        <div id="audit-rider-name" style="font-size:22px; font-weight:900; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:5px;">-</div>
                        <div class="audit-stat"><span>Orders Completed:</span> <b id="audit-count">0</b></div>
                        <div class="audit-stat"><span>Cash Collected:</span> <b id="audit-cash">Rs 0</b></div>
                        <div class="audit-stat"><span>Rider Fees:</span> <b id="audit-fees">Rs 0</b></div>
                        <hr style="opacity:0.2;">
                        <div class="audit-stat"><span>Net to Shop:</span> <b id="audit-net">Rs 0</b></div>
                    </div>
                </div>
            </div>
            
            <!-- DELIVERY HISTORY SIDEBAR -->
            <div id="delivery-history-sidebar">
                <h3 style="margin-top:0; color:var(--red); display:flex; align-items:center; gap:10px;">
                    <span>üìç Delivery Checks</span>
                    <span style="background:var(--orange); color:white; padding:3px 10px; border-radius:10px; font-size:11px;" id="calc-history-count">0</span>
                </h3>
                <p style="font-size:12px; color:#666; margin-bottom:15px;">Recent delivery charge calculations with locations</p>
                <div id="delivery-history-list" style="flex:1; overflow-y:auto;">
                    <p style="text-align:center; color:#999; padding:20px;">Loading...</p>
                </div>
                <button onclick="clearDeliveryHistory()" style="width:100%; padding:12px; background:#ffebee; color:#c62828; border:2px dashed #c62828; border-radius:12px; font-weight:900; margin-top:10px; cursor:pointer;">
                    CLEAR HISTORY
                </button>
            </div>
        </div>
        <div style="padding:15px; border-top:1px solid #eee; display:flex; gap:10px;">
            <button class="next-btn btn-3d" style="background:#444; flex:1;" onclick="clearReadyOrders()">CLEAR READY (DINE-IN)</button>
            <button id="clear-del-btn" class="next-btn btn-3d" style="background:var(--red); display:none; flex:1;" onclick="clearDeliveriesWithPassword()">CLEAR ALL DELIVERIES</button>
        </div>
    </div>
</div>

<div id="flavor-overlay"><div class="modal"><h3 id="flavor-title" style="color:var(--red); font-weight:900;">Pick Flavor</h3><div class="grid" id="flavor-grid"></div><button onclick="closeModals()" style="margin-top:25px; border:none; background:none; color:#bbb; font-weight:900;">CANCEL</button></div></div>
<div id="welcome-overlay"><div class="modal"><h2 style="color:var(--red); font-weight:900;">HEY THERE! üëã</h2><p id="welcome-msg">Where do you want your food?</p><div class="input-group" id="service-options-container"></div></div></div>
<div id="modal-overlay"><div class="modal"><h3 id="modal-item-name" style="color:var(--red); font-weight:900; margin-top:0;"></h3><p style="font-weight:bold; color:#777;">How many?</p><div class="qty-btns"><button class="qty-btn btn-3d" onclick="setQty(1)">1</button><button class="qty-btn btn-3d" onclick="setQty(2)">2</button><button class="qty-btn btn-3d" onclick="setQty(3)">3</button><button class="qty-btn btn-3d" onclick="setQty(4)">4</button><button class="qty-btn btn-3d active" onclick="setQty(5)">5+</button></div><textarea id="special-note" placeholder="Any special notes?"></textarea><div style="margin-top:25px; display:flex; gap:12px;"><button onclick="closeModals()" class="btn-3d" style="flex:1; padding:15px; border-radius:20px; background:#eee;">BACK</button><button onclick="addToCartFinal()" class="btn-3d" style="flex:1.5; padding:15px; border-radius:20px; background:var(--orange); color:white; font-weight:900; box-shadow:0 5px 0px var(--dark-orange);">ADD TO BAG</button></div></div></div>
<div id="size-overlay"><div class="modal"><h3 style="font-weight:900;">Select Size</h3><div class="grid" id="size-grid"></div><button onclick="closeModals()" style="margin-top:20px; border:none; background:none; color:gray; font-weight:900;">CANCEL</button></div></div>
<div id="overlay-screen"><button class="header-back-btn btn-3d" id="checkout-back-btn" onclick="closeCheckout()" style="margin-bottom:20px; padding:12px 25px;">‚Üê BACK</button><div id="checkout-content"></div></div>

<!-- LIVE TRACKING OVERLAY -->
<div id="tracking-overlay">
    <div class="modal">
        <span id="track-icon" class="tracking-status-icon">üì©</span>
        <h2 id="track-main-status" style="color:var(--red); font-weight:900; margin-bottom:5px;">Order Sent!</h2>
        <p id="track-sub-status" style="font-weight:bold; color:#777;">Waiting for confirmation...</p>
        <div style="margin:30px 0; text-align:left; padding-left:15%;">
            <div id="step-waiting" class="tracking-step active">‚úÖ Sent to Kitchen</div>
            <div id="step-preparing" class="tracking-step">üîò Chef is Preparing</div>
            <div id="step-ready" class="tracking-step">üîò Food is Ready!</div>
        </div>
        <button onclick="clearTracking()" class="btn-3d" style="width:100%; padding:15px; border-radius:20px; background:#eee; font-weight:900;">CLOSE TRACKER</button>
    </div>
</div>

<!-- SMART UPSELL OVERLAY -->
<div id="upsell-overlay">
    <div class="modal" style="border:4px solid var(--orange);">
        <span id="upsell-icon" style="font-size:60px;">üçüü•§</span>
        <h2 id="upsell-title" style="color:var(--red); font-weight:900; margin:10px 0;">HUNGRY?</h2>
        <div id="upsell-body-content">
            <p id="upsell-desc" style="font-weight:bold; color:#555; margin-bottom:20px;"></p>
            <button id="upsell-yes-btn" class="confirm-btn btn-3d" style="margin-top:0; background:var(--orange); box-shadow: 0 6px 0px var(--dark-orange);">YES, ADD IT! üöÄ</button>
        </div>
        <button onclick="document.getElementById('upsell-overlay').style.display='none'; setScrollLock(false);" style="margin-top:20px; border:none; background:none; color:#bbb; font-weight:900; width:100%;">NO THANKS, CONTINUE</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    let audioCtx = null;
    function playClick(type = 'pop') { 
        try { 
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sine'; 
            if(type === 'pop') { osc.frequency.setValueAtTime(600, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(10, audioCtx.currentTime + 0.1); } 
            else if(type === 'thud') { osc.frequency.setValueAtTime(300, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(1, audioCtx.currentTime + 0.2); } 
            else if(type === 'siren') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(400, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(800, audioCtx.currentTime + 0.2); osc.frequency.linearRampToValueAtTime(400, audioCtx.currentTime + 0.4); }
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + (type === 'siren' ? 0.4 : 0.1)); 
            osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + (type === 'siren' ? 0.4 : 0.1)); 
        } catch(e) { } 
    }

    const SUPABASE_URL = "https://zlvgoebqmmbkfpjecghl.supabase.co";
const SUPABASE_KEY = "sb_publishable_Ne2oa1AfKlv85Bt8jPZyYw_QV2Hg0aq";
let sb = null;
try { sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e) { console.error("Supabase load error"); }

    let cart = [], selectedItem = null, selectedQty = 1, orderType = "", tableNum = "", userAddress = "", delCharge = 0, chkStep = 1, dealChoices = [], currentFlavorStep = 0, isQRScan = false, kitchenInterval = null;
    let currentKitchenFilter = 'ALL';
    let currentCalcData = null; // Store calculation data
    const RIDERS = ["Ramzan", "Abdurehman", "Abu Bakar", "Atif", "Ahsan"];
    const LOYALTY_PRIZES = ["Pan Pizza (S)", "Zinger Burger", "Club Sandwich", "Loaded Fries", "6pcs Wings", "Chipotle Wrap"];
    
    // OvenX Bahawalpur Coordinates - UPDATED
    const OVENX_COORDS = { lat: 29.383762003438022, lng: 71.67093485767057 };
    const PRICE_PER_KM = 12;

    try {
    const urlParams = new URLSearchParams(window.location.search);
    if(urlParams.has('table')) { 
        isQRScan = true; 
        tableNum = urlParams.get('table').toUpperCase();
        
        // Validate table number (A1-A20 or B1-B17)
        const validTable = /^[AB]([1-9]|1[0-7])$/.test(tableNum) || /^A(1[0-9]|20)$/.test(tableNum);
        
        if(validTable) {
            document.getElementById('gateway-table-id').innerText = tableNum; 
            document.getElementById('gateway-table-note').style.display = 'block'; 
            document.getElementById('header-table-indicator').innerText = "(TABLE " + tableNum + ")";
        } else {
            // Invalid table - treat as regular customer
            isQRScan = false;
            tableNum = "";
        }
    }
} catch(e) { }

    const menuData = {
        "Starter üçü": [{name: "Plain Fries", price: {Reg: 230, Large: 300}}, {name: "Loaded Fries", price: 599}, {name: "Pizza Fries", price: 720}, {name: "Dragon Shots", price: 399}, {name: "Oven Baked Wings", price: {Reg: 399, Large: 780}}, {name: "Peri-Peri Wings", price: {M: 399, L: 780}}, {name: "Hot Wings", price: {M: 399, L: 780}}, {name: "Honey Chili Wings", price: {M: 449, L: 880}}, {name: "Cheese Sticks", price: 449}, {name: "Meat Sticks", price: 449}, {name: "Nuggets", price: {M: 350, L: 650}}],
        "Sandwich ü•™": [{name: "Health Harvest", price: 599}, {name: "Khameera Sandwich", price: 699}, {name: "Club Sandwich", price: 599}],
        "Fried Burger üçî": [{name: "Chicken Patty Burger", price: 299}, {name: "Zinger Burger", price: 420}, {name: "Mighty Burger", price: 699}, {name: "Chipotle Burger", price: 649}, {name: "Crispy Jalapeno", price: 549}, {name: "Stuff Jalapeno", price: 649}],
        "Grilled Burger ‚ô®Ô∏è": [{name: "CM Grilled", price: 499}, {name: "Smokey Grilled", price: 550}, {name: "Peri Peri Grilled", price: 749}, {name: "Drizzler X", price: 749}, {name: "Jalapeno Blaze", price: 749}, {name: "Mexi Fiesta", price: 749}],
        "Pan Pizza üçï": [{name: "Chicken Tikka", price: {S:499, M:999, L:1549}}, {name: "Chicken Fajita", price: {S:499, M:999, L:1549}}, {name: "Chicken Supreme", price: {S:499, M:999, L:1549}}, {name: "Cheese Lover", price: {S:499, M:999, L:1549}}, {name: "Veg Lover", price: {S:499, M:999, L:1549}}, {name: "Sicilian Pizza", price: {S:499, M:999, L:1549}}],
        "Premium Pizza üåü": [{name: "BBQ Pizza", price: {M:1199, L:1699}}, {name: "Creamy Dreamy", price: {M:1199, L:1699}}, {name: "OvenX Special Premium", price: {M:1199, L:1699}}, {name: "Bonfire Pizza", price: {M:1199, L:1699}}],
        "Deep Dish Pizza üç≤": [{name: "Mild Butter", price: {M:1749, L:2449}}, {name: "OvenX Special Deep Dish", price: {M:1749, L:2449}}],
        "Extreme Pizza üå∂Ô∏è": [{name: "Extreme Peri Peri", price: {M:1499, L:2049}}, {name: "Extreme Flaming Kabab", price: {M:1499, L:2049}}, {name: "Crispy Extreme", price: {M:1499, L:2049}}],
        "Craft My Own Pizza üé®": [{name: "Kabab Crust", price: {Med: 1399, Large: 1799}}, {name: "Crown Crust", price: {Med: 1399, Large: 1799}}, {name: "Cheese Crust", price: {Med: 1399, Large: 1799}}, {name: "Crusti Thin", price: 1699}],
        "Platters üç±": [{name: "Khameera Sandwich Platter", price: 699}, {name: "Calzone Platter", price: 899}, {name: "Behari Platter", price: 949}],
        "Pasta üçù": [{name: "Alfredo Pasta", price: 749}, {name: "OvenX Flaming Pasta", price: 650}, {name: "Fire Kissed Pasta", price: 699}, {name: "X-Special Pasta", price: 749}],
        "Wraps & Rolls üåØ": [{name: "Chipotle Wrap", price: 699}, {name: "BBQ Wrap", price: 599}, {name: "Donar Kabab", price: 749}, {name: "Crunch Wrap", price: 449}, {name: "Zingeratha Roll", price: 449}, {name: "Paratha Roll", price: 449}, {name: "Malai Roll", price: 449}, {name: "Behari Roll", price: 749}, {name: "Peri Peri Wrap", price: 749}],
        "Bar Menu ü•§": [{name: "Coke Buddy", price: 130}, {name: "Sprite Buddy", price: 130}, {name: "Coke 1 Liter", price: 190}, {name: "Next Cola 1 Liter", price: 170}, {name: "Coke 1.5L", price: 230}, {name: "Sprite 1.5L", price: 230}, {name: "Water Small", price: 99}, {name: "Water Large", price: 170}]
    };
    menuData["Pan/Premium"] = [...menuData["Pan Pizza üçï"], ...menuData["Premium Pizza üåü"]];

    const dealsData = [
        { name: "Midnight Deal 1", desc: "2x Med Extreme Pizzas + 1.5L Drink", price: 2699, badge: "HOT DEAL", image: "https://images.getbento.com/accounts/f26197ccf036932f404d45389d32707a/media/images/1899hanoiFinal_1025.JPG?w=1200&fit=crop&auto=compress,format&cs=origin&crop=focalpoint&fp-x=0.5&fp-y=0.5", flavorsNeeded: [{label: "Pizza 1", cat: "Extreme Pizza üå∂Ô∏è"}, {label: "Pizza 2", cat: "Extreme Pizza üå∂Ô∏è"}], fixedItems: ["1.5L Soft Drink"] },
        { name: "Midnight Deal 2", desc: "1x Large wings + 2x Large Pan Pizzas + 1.5L Drink", price: 3249, badge: "SAVER", image: "https://www.citysouthpizzakitchenerwaterloo.ca/cdn/shop/files/pizza-with-3-toppings-chicken-wings-and-3-cokes.png?v=1759010649&width=533", flavorsNeeded: [{label: "Pizza 1", cat: "Pan Pizza üçï"}, {label: "Pizza 2", cat: "Pan Pizza üçï"}], fixedItems: ["1x Large Hot Wings", "1.5L Soft Drink"] },
        { name: "Midnight Deal 3", desc: "1x Large wings + 2x Large Premium Pizzas + 1.5L Drink", price: 3649, badge: "PREMIUM", image: "https://assets3.thrillist.com/v1/image/2826030/792x528/scale;webp=auto;jpeg_quality=60;progressive.jpg", flavorsNeeded: [{label: "Pizza 1", cat: "Premium Pizza üåü"}, {label: "Pizza 2", cat: "Premium Pizza üåü"}], fixedItems: ["1x Large Hot Wings", "1.5L Soft Drink"] },
        { name: "Midnight Deal 4", desc: "1x Med Extreme Pizza + 1x Large Extreme Pizza + 1.5L Drink", price: 3149, badge: "MIX DEAL", image: "https://images.getbento.com/accounts/f26197ccf036932f404d45389d32707a/media/images/40247IMG_0030pie.jpeg?w=1200&fit=crop&auto=compress,format&cs=origin&crop=focalpoint&fp-x=0.5&fp-y=0.5", flavorsNeeded: [{label: "Medium Pizza", cat: "Extreme Pizza üå∂Ô∏è"}, {label: "Large Pizza", cat: "Extreme Pizza üå∂Ô∏è"}], fixedItems: ["1.5L Soft Drink"] },
        { name: "Family Feast", desc: "2 Med Pizzas + 2 Zingers + 1L Drink + 6 Wings", price: 2299, badge: "FAMILY", image: "https://prairiepizzas.ca/wp-content/uploads/2020/07/family-combo-2.jpg", flavorsNeeded: [{label: "Pizza 1", cat: "Pan/Premium"}, {label: "Pizza 2", cat: "Pan/Premium"}], fixedItems: ["2x Zinger Burgers", "1L Drink", "6x Wings"] },
        { name: "Extreme Buddy", desc: "1 Medium Extreme Pizza + Free 1L Drink", price: 1449, badge: "BEST SELLER", image: "https://media.sodagift.com/img/image/1877697001877199.jpg", flavorsNeeded: [{label: "Pizza Flavor", cat: "Extreme Pizza üå∂Ô∏è"}], fixedItems: ["1L Drink"] },
        { name: "Burger Deal 1", desc: "2 Zingers + 1 Reg Fries + 2 Drinks", price: 999, badge: "DELIVERY", image: "https://www.shutterstock.com/image-photo/crispy-chicken-burger-served-french-600nw-2647455697.jpg", fixedItems: ["2x Zinger Burgers", "1x Regular Fries", "2x Drinks"] },
        { name: "Burger Deal 2", desc: "1 Zinger + 1 Reg Fries + 1 345ml Drink + 2 Wings", price: 990, badge: "DELIVERY", image: "https://d1w7312wesee68.cloudfront.net/papYm9QPXbu985kLHmECoETz9chauwF12d0PGs2MVKY/resize:fit:720:720/plain/s3://toasttab/restaurants/restaurant-255618000000000000/menu/items/7/item-5740050945299277_1766103306.jpg", fixedItems: ["1x Zinger Burger", "1x Regular Fries", "1x 345ml Buddy Drink", "2x Pcs Wings"] },
        { name: "Burger Deal 3", desc: "4 Classic Zingers + 2 Reg Fries + 1L Drink + 6 Wings", price: 1990, badge: "DELIVERY", image: "https://www.corriecooks.com/wp-content/uploads/2025/05/Zinger-Burger-500x500.jpg", fixedItems: ["4x Classic Zinger Burgers", "2x Regular Fries", "1x 1 Liter Drink", "6x Pcs Wings"] },
        { name: "01 PIZZA DEAL", desc: "1 Large Pizza (Pan) + 1L Drink", price: 1299, badge: "DELIVERY", image: "https://media.sodagift.com/img/image/678369644447129.jpg", flavorsNeeded: [{label: "Pizza", cat: "Pan Pizza üçï"}], fixedItems: ["1L Drink"] },
        { name: "02 PIZZA DEAL", desc: "1 Large Pizza (Premium) + 1L Drink", price: 1499, badge: "DELIVERY", image: "https://www.tastingtable.com/img/gallery/how-pizza-and-chicken-wings-became-a-classic-combo/intro-1740444362.jpg", flavorsNeeded: [{label: "Pizza", cat: "Premium Pizza üåü"}], fixedItems: ["1L Drink"] },
        { name: "03 PIZZA DEAL", desc: "1 Large Crown Pizza + 1L Drink", price: 1599, badge: "DELIVERY", image: "https://static.tossdown.com/images/a8418568-6a3e-433b-acb3-7effa408d5d0.webp", flavorsNeeded: [{label: "Crown Flavor", cat: "Craft My Own Pizza üé®"}], fixedItems: ["1L Drink"] },
        { name: "04 PIZZA DEAL", desc: "1 Large Extreme Pizza + 1L Drink", price: 1999, badge: "DELIVERY", image: "https://images.getbento.com/accounts/f26197ccf036932f404d45389d32707a/media/images/40247IMG_0030pie.jpeg?w=1200&fit=crop&auto=compress,format&cs=origin&crop=focalpoint&fp-x=0.5&fp-y=0.5", flavorsNeeded: [{label: "Extreme Flavor", cat: "Extreme Pizza üå∂Ô∏è"}], fixedItems: ["1L Drink"] }
    ];

    const imgMap = {
        "plain fries": "https://www.recipetineats.com/tachyon/2022/09/Crispy-Fries_8.jpg?resize=500%2C375",
        "loaded fries": "https://www.carolynscooking.com/wp-content/uploads/2024/01/Loaded-Bacon-Cheese-Fries-3.jpg",
        "pizza fries": "https://lh3.googleusercontent.com/-ntf8I5R_xC4/Vffe9Jy-I6I/AAAAAAAFKz8/NxqHy-TAfbo/s800-Ic42/pizza-dough-fries-75a.jpg",
        "dragon shots": "https://www.indianhealthyrecipes.com/wp-content/uploads/2021/12/chicken-lollipop.jpg",
        "oven baked wings": "https://tastesbetterfromscratch.com/wp-content/uploads/2014/09/Baked-Chicken-Wings-3.jpg",
        "peri-peri wings": "https://www.thespicehouse.com/cdn/shop/articles/Insane_Hot_Wings_720x.jpg?v=1588270427",
        "hot wings": "https://www.thespicehouse.com/cdn/shop/articles/Insane_Hot_Wings_720x.jpg?v=1588270427",
        "honey chili wings": "https://www.chilitochoc.com/wp-content/uploads/2025/01/hot-honey-chicken-wings-with-sauce-and-chili-flakes.jpg",
        "cheese sticks": "https://www.spendwithpennies.com/wp-content/uploads/2013/10/Cheese-Sticks-SpendWithPennies-2-22.jpg",
        "meat sticks": "https://www.teaforturmeric.com/wp-content/uploads/2018/10/Seekh-Kebab-4.jpg",
        "nuggets": "https://cdn.apartmenttherapy.info/image/upload/f_jpg,q_auto:eco,c_fill,g_auto,w_1500,ar_1:1/k%2FPhoto%2FRecipe%20Ramp%20Up%2F2022-02-Baked-Chicken-Wings%2FIMG_6923_f6aa7e_landscape",
        "health harvest": "https://www.themediterraneandish.com/wp-content/uploads/2024/03/TMD-Vegetable-Sandwich-Leads-02-Horizontal.jpg",
        "khameera": "https://media.sailusfood.com/wp-content/uploads/2008/05/mutton_kheema_sandwich.jpg",
        "club sandwich": "https://media.sailusfood.com/wp-content/uploads/2008/05/mutton_kheema_sandwich.jpg",
        "chicken patty": "https://www.themediterraneandish.com/wp-content/uploads/2024/05/Chicken-Burger-16.jpg",
        "zinger": "https://fantabulosity.com/wp-content/uploads/2021/10/Crispy-Chicken-Burger-34.jpg",
        "mighty": "https://halaladdict.com/wp-content/uploads/2023/05/Mighty-Zinger-Burger.png",
        "chipotle": "https://lisagcooks.com/wp-content/uploads/2016/07/Spicy-Chipotle-Burger-1.jpg",
        "crispy jalapeno": "https://bjsrestaurants.scene7.com/is/image/bjsrestaurants/loaded-burgers-crispyjalapenoburger-5366r-bjs",
        "stuff jalapeno": "https://www.babaganosh.org/wp-content/uploads/2022/12/jalapeno-popper-burgers-44.jpg",
        "cm grilled": "https://www.kimscravings.com/wp-content/uploads/2022/06/Chicken-Burgers-5.jpg",
        "smokey grilled": "https://www.grocery.coop/wp-content/uploads/2015/12/Smoky_Grilled_Burgers_0.jpg",
        "peri peri grilled": "https://www.recipetineats.com/uploads/2015/11/Nandos-Peri-Peri-Chicken-Burger_9.jpg",
        "drizzler": "https://www.campchef.com/dw/image/v2/BDBJ_PRD/on/demandware.static/-/Sites-CampChef-Library/default/dw5b9d74ec/Recipe-Heros/Smoked-Burger.png",
        "jalapeno blaze": "https://amazingribs.com/wp-content/uploads/2023/02/jalapeno-bacon-cheeseburger.jpg",
        "mexi fiesta": "https://images.contentstack.io/v3/assets/blt9039451385f46c16/blt0d4471c6a90418b1/64a64affee0ad3ed47beaadd/VegieDelightsMay-June2023-2-2_(1).jpg",
        "chicken tikka": "https://www.greedygourmet.com/wp-content/uploads/2024/12/chicken-tikka-pizza-feature.jpg",
        "chicken fajita": "https://boboli.com/sites/default/files/2022-06/chicken_fajita_LR_0.jpg",
        "chicken supreme": "https://thegingeredwhisk.com/wp-content/uploads/2020/10/Chicken-Supreme-Pizza-17.jpg",
        "cheese lover": "https://nmgprod.s3.amazonaws.com/media/files/16/e9/16e9f32596537b9563af50d1d0a2dbad/cover_image.jpg.960x540_q85_crop_upscale.jpg",
        "veg lover": "https://www.orchidsandsweettea.com/wp-content/uploads/2019/05/Veggie-Pizza-2-of-5-e1691215701129.jpg",
        "sicilian": "https://www.chewoutloud.com/wp-content/uploads/2013/02/deep-dish-pizza-3.jpg",
        "bbq": "https://bluebowlrecipes.com/wp-content/uploads/2019/05/barbecue-chicken-pizza-0917.jpg",
        "creamy dreamy": "https://i.shgcdn.com/c4d973d8-3799-4122-a601-0d51c1d73bd1/-/format/auto/-/preview/3000x3000/-/quality/lighter/",
        "ovenx special": "https://images.getbento.com/accounts/f26197ccf036932f404d45389d32707a/media/images/37992IMG_0038pie.JPG?w=1200&fit=crop&auto=compress,format&cs=origin&crop=focalpoint&fp-x=0.5&fp-y=0.5",
        "bonfire": "https://kristineskitchenblog.com/wp-content/uploads/2025/05/bbq-chicken-pizza-09-2.jpg",
        "mild butter": "https://colavitarecipes.com/wp-content/uploads/2020/06/chicago-11-F-1200x1800.jpg",
        "extreme peri": "https://www.thecandidcooks.com/wp-content/uploads/2022/08/spicy-sausage-pepper-pizza-feature.jpg",
        "flaming kabab": "https://www.greedygourmet.com/wp-content/uploads/2024/12/chicken-tikka-pizza-feature.jpg",
        "crispy extreme": "https://images.getbento.com/accounts/f26197ccf036932f404d45389d32707a/media/images/37992IMG_0038pie.JPG?w=1200&fit=crop&auto=compress,format&cs=origin&crop=focalpoint&fp-x=0.5&fp-y=0.5",
        "kabab crust": "https://www.greedygourmet.com/wp-content/uploads/2024/12/chicken-tikka-pizza-feature.jpg",
        "crown crust": "https://d3ed0bx5qudxt4.cloudfront.net/912136134",
        "cheese crust": "https://sallysbakingaddiction.com/wp-content/uploads/2017/03/stuffed-crust-pizza-3.jpg",
        "crusti thin": "https://www.washingtonpost.com/wp-apps/imrs.php?src=https://arc-anglerfish-washpost-prod-washpost.s3.amazonaws.com/public/KFHFXR3G3YSLKJETDTO24K5SCM.jpg&w=1800&h=1800",
        "khameera platter": "https://cdnimg.webstaurantstore.com/images/products/large/661056/2284466.jpg",
        "calzone": "https://res.cloudinary.com/hksqkdlah/image/upload/c_fill,dpr_2.0,f_auto,fl_lossy.progressive.strip_profile,g_faces:auto,q_auto:low/SFS_chicago_deep_dish_pizza-16_cehf9d",
        "behari": "https://www.seriouseats.com/thmb/6zN8jRJEFn1rU3It2_rSU2pxZpE=/1500x0/filters:no_upscale():max_bytes(150000):strip_icc()/__opt__aboutcom__coeus__resources__content_migration__serious_eats__seriouseats.com__recipes__20160801-seekh-kebab-recipe-41-1fdc2ebd109b4bbd8d4c00455b505379.jpg",
        "alfredo": "https://www.gimmesomeoven.com/wp-content/uploads/2020/04/Alfredo-Sauce-9.jpg",
        "flaming pasta": "https://www.thecountrycook.net/wp-content/uploads/2023/02/thumbnail-Penne-Pasta-with-Tomato-Sauce-scaled.jpg",
        "fire kissed": "https://www.thecountrycook.net/wp-content/uploads/2023/02/thumbnail-Penne-Pasta-with-Tomato-Sauce-scaled.jpg",
        "x-special": "https://cookingwithcassandra.com/wp-content/uploads/2022/10/Copy-of-Copy-of-DSC03750-2-scaled.jpg",
        "chipotle wrap": "https://www.dontgobaconmyheart.co.uk/wp-content/uploads/2019/06/bbq-chicken-wrap.jpg",
        "bbq wrap": "https://www.everyday-delicious.com/wp-content/uploads/2022/04/bbq-chicken-wrap-everyday-delicious-1.jpg",
        "doner": "https://silkroadrecipes.com/wp-content/uploads/2024/06/Turkish-Doner-Kebabs-Beef-or-Lamb-square.jpg",
        "crunch wrap": "https://www.valyastasteofhome.com/wp-content/uploads/2022/08/The-BEST-Crunchwrap-Supreme-5.jpg",
        "zingeratha": "https://www.flourandspiceblog.com/wp-content/uploads/2021/05/IMG_2742.jpg",
        "paratha": "https://www.flourandspiceblog.com/wp-content/uploads/2021/05/IMG_2742.jpg",
        "malai": "https://thespicemess.com/wp-content/uploads/2021/07/Malai-Boti-Rolls-14.jpg",
        "peri wrap": "https://img-global.cpcdn.com/recipes/bf130e2c7e935656/680x781cq80/nandos-style-peri-peri-chicken-wrap-recipe-main-photo.jpg",
        "coke buddy": "https://dialacoke.com/media/catalog/product/cache/ea9fd91bf69f7931ab0fc6320db4b8ac/c/o/coke-pet-350ml.jpg",
        "sprite buddy": "https://grandmall.grandhyper.com/image/cache/catalog/products/1/40822099-500x500.jpg",
        "coke 1 liter": "https://www.melandrose.com/prodimages/2184-DEFAULT-l.jpg",
        "next cola": "https://www.melandrose.com/prodimages/2184-DEFAULT-l.jpg",
        "coke 1.5l": "https://i5.walmartimages.com/asr/4271ee10-c8d4-49ad-b24d-2a37e9f6e8a4.17444fb4917300d9fcdf16709c0253a7.jpeg",
        "sprite 1.5l": "https://m.media-amazon.com/images/I/51HQiqPnFWL._AC_UF894,1000_QL80_.jpg",
        "water small": "https://www.purelifewater.com/sites/g/files/zmtnxh126/files/image%204.png",
        "water large": "https://www.purelifewater.com/sites/g/files/zmtnxh126/files/image%204.png",
    };

    function setScrollLock(lock) { if(lock) document.body.classList.add('modal-active'); else document.body.classList.remove('modal-active'); }
    
    /* --- LOYALTY LOGIC --- */
    function renderLoyaltyCard() {
        const name = localStorage.getItem('ovenx_member_name');
        const stamps = parseInt(localStorage.getItem('ovenx_stamps') || 0);
        if(!name) {
            document.getElementById('join-club-btn').style.display = 'block';
            document.getElementById('loyalty-display').style.display = 'none';
            return;
        }
        document.getElementById('join-club-btn').style.display = 'none';
        document.getElementById('loyalty-display').style.display = 'block';
        document.getElementById('club-member-name').innerText = name.toUpperCase();
        const row1 = document.getElementById('stamp-row-1'); 
        const row2 = document.getElementById('stamp-row-2');
        row1.innerHTML = ""; row2.innerHTML = "";
        for(let i=1; i<=10; i++) {
            const circle = document.createElement('div');
            circle.className = "stamp-circle" + (i <= stamps ? " filled" : "");
            circle.innerHTML = i <= stamps ? "üî•" : i;
            if(i <= 6) row1.appendChild(circle); else row2.appendChild(circle);
        }
        const msg = document.getElementById('loyalty-msg');
        if(stamps >= 10) msg.innerHTML = "üéÅ <span class='gold-label'>UNLOCKED: MYSTERY MEAL!</span><br>Order now to claim your gift!";
        else msg.innerHTML = `Order ${10 - stamps} more times (Above Rs 1000) to unlock a <span class='gold-label'>Free Mystery Meal</span>`;
    }

    function requestNotificationPermission() {
        if ("Notification" in window) {
            if (Notification.permission === "default") {
                Notification.requestPermission().then(permission => {
                    console.log("Notification permission:", permission);
                });
            }
        }
    }

    function openLoyaltySetup() { document.getElementById('loyalty-setup-overlay').style.display = 'flex'; setScrollLock(true); }
    
    async function saveClubProfile() {
        const n = document.getElementById('clubName').value;
        const p = document.getElementById('clubPhone').value;
        if(!n || !p) return alert("Enter your name and WhatsApp number!");
        
        if(sb) {
            await sb.from('gold_club_members').insert([{ name: n, phone: p }]);
        }

        localStorage.setItem('ovenx_member_name', n);
        localStorage.setItem('ovenx_member_phone', p);
        localStorage.setItem('ovenx_stamps', 0);
        
        document.getElementById('loyalty-setup-overlay').style.display = 'none';
        setScrollLock(false);
        renderLoyaltyCard();
        alert("Welcome to the Club, " + n + "! üëë");
    }

    function enterApp(target) { 
        playClick('thud'); 
        requestNotificationPermission();
        document.getElementById('gateway-screen').style.display = 'none'; 
        document.getElementById('top-sticky-container').style.display = 'flex'; 
        if(tableNum && orderType === "") { renderServiceOptions(); document.getElementById('welcome-overlay').style.display = 'flex'; setScrollLock(true); } 
        if(target === 'deals') switchTab('deals'); else switchTab('menu'); 
    }
    
    function renderServiceOptions() { const container = document.getElementById('service-options-container'); let html = `<button class="next-btn btn-3d" onclick="setInitialService('Dine-In')" style="background:#007bff; box-shadow: 0 6px 0px #0056b3;">üçΩÔ∏è Eat Here (7% SC)</button><button class="next-btn btn-3d" onclick="setInitialService('Takeaway')" style="background:#6c757d; box-shadow: 0 6px 0px #495057;">ü•° Take Home</button>`; if (!isQRScan) { html += `<button class="next-btn btn-3d" style="background:var(--red); box-shadow: 0 6px 0px var(--dark-red);" onclick="setInitialService('Delivery')">üöö Delivery</button>`; } container.innerHTML = html; }
    function exitToGateway() { playClick('pop'); document.getElementById('gateway-screen').style.display = 'flex'; document.getElementById('top-sticky-container').style.display = 'none'; document.getElementById('cart-bar').style.display = 'none'; renderLoyaltyCard(); setScrollLock(false); }
    function switchTab(tab) { playClick('pop'); if(tab === 'menu') { document.getElementById('menu-container').style.display = 'block'; document.getElementById('deals-container').style.display = 'none'; document.getElementById('tab-menu').classList.add('active'); document.getElementById('tab-deals').classList.remove('active'); document.getElementById('menu-controls').style.display = 'block'; renderPublicMenu(); } else { document.getElementById('menu-container').style.display = 'none'; document.getElementById('deals-container').style.display = 'block'; document.getElementById('tab-deals').classList.add('active'); document.getElementById('tab-menu').classList.remove('active'); document.getElementById('menu-controls').style.display = 'none'; renderPublicDeals(); } }

    function openOrderFlow(item) {
        playClick('pop'); selectedItem = JSON.parse(JSON.stringify(item)); dealChoices = []; currentFlavorStep = 0;
        if (selectedItem.flavorsNeeded) { startFlavorSelection(); } 
        else if (item.price && typeof item.price === 'object') {
            const sizeGrid = document.getElementById('size-grid'); sizeGrid.innerHTML = '';
            for (let s in item.price) { let sBtn = document.createElement('div'); sBtn.className = 'btn btn-3d'; sBtn.innerHTML = `<div class="item-label-box"><div>${s}</div><div class="price-tag">Rs ${item.price[s]}</div></div>`; sBtn.onclick = function() { playClick('pop'); selectedItem.name += " (" + s + ")"; selectedItem.price = item.price[s]; document.getElementById('size-overlay').style.display = 'none'; openQtyModal(); }; sizeGrid.appendChild(sBtn); }
            document.getElementById('size-overlay').style.display = 'flex'; setScrollLock(true);
        } else { openQtyModal(); }
    }
    
    function startFlavorSelection() {
        const step = selectedItem.flavorsNeeded[currentFlavorStep]; document.getElementById('flavor-title').innerText = "Pick " + step.label; const grid = document.getElementById('flavor-grid'); grid.innerHTML = ''; let flavors = menuData[step.cat] || [];
        flavors.forEach(f => {
            const b = document.createElement('div'); b.className = 'btn btn-3d'; b.innerHTML = `<div class="item-label-box"><div>${f.name}</div></div>`;
            b.onclick = function() { b.classList.add('size-feedback'); playClick('pop'); setTimeout(() => { dealChoices.push(`${selectedItem.flavorsNeeded[currentFlavorStep].label}: ${f.name}`); currentFlavorStep++; if (currentFlavorStep < selectedItem.flavorsNeeded.length) startFlavorSelection(); else { document.getElementById('flavor-overlay').style.display = 'none'; selectedItem.flavorNotes = dealChoices.join(", "); openQtyModal(); } }, 100); }; grid.appendChild(b);
        });
        document.getElementById('flavor-overlay').style.display = 'flex'; setScrollLock(true);
    }
    
    function openQtyModal() { 
        document.getElementById('modal-item-name').innerText = selectedItem.name; 
        document.getElementById('special-note').value = "";
        setQty(1); 
        document.getElementById('modal-overlay').style.display = 'flex'; 
        setScrollLock(true); 
    }

    function setQty(q) { 
        playClick('pop'); 
        selectedQty = q; 
        document.querySelectorAll('.qty-btn').forEach((b, i) => { 
            b.classList.remove('active'); 
            if (i === (q===5?4:q-1)) b.classList.add('active'); 
        }); 
    }

    function closeModals() { 
        document.querySelectorAll('#modal-overlay, #flavor-overlay, #size-overlay').forEach(el => el.style.display='none'); 
        setScrollLock(false); 
    }

    function initCustomerTracking(orderId) {
        if(!orderId) return;
        localStorage.setItem('ovenx_last_order_id', orderId);
        document.getElementById('tracking-overlay').style.display = 'flex';
        setScrollLock(true);

        sb.from('kitchen_orders').select('status').eq('id', orderId).single()
        .then(({data}) => { if(data) updateTrackingUI(data.status); });

        sb.channel(`track-${orderId}`)
        .on('postgres_changes', 
            { 
                event: 'UPDATE', 
                schema: 'public', 
                table: 'kitchen_orders', 
                filter: `id=eq.${orderId}` 
            }, 
            (payload) => {
                updateTrackingUI(payload.new.status);
            })
        .subscribe();
    }

    function updateTrackingUI(status) {
        const icon = document.getElementById('track-icon');
        const main = document.getElementById('track-main-status');
        const sub = document.getElementById('track-sub-status');
        const sWait = document.getElementById('step-waiting');
        const sPrep = document.getElementById('step-preparing');
        const sReady = document.getElementById('step-ready');
        
        document.querySelectorAll('.tracking-step').forEach(s => s.classList.remove('active'));
        
        sWait.innerHTML = "‚úÖ Sent to Kitchen";
        sPrep.innerHTML = "üîò Chef is Preparing";
        sReady.innerHTML = "üîò Food is Ready!";

        sWait.classList.add('active');
        
        if(status === 'PREPARING') { 
            window.navigator.vibrate([200, 100, 200]); 
            icon.innerText = "üë®‚Äçüç≥"; 
            main.innerText = "Chef is Cooking!"; 
            sub.innerText = "Your dough is being tossed right now!"; 
            sPrep.innerHTML = "‚úÖ Chef is Preparing";
            sPrep.classList.add('active'); 
        } 
        else if(status === 'READY') { 
            window.navigator.vibrate([500, 110, 500]); 
            icon.innerText = "üî•"; 
            main.innerText = "Order Ready!"; 
            sub.innerText = "Freshly baked and hot!"; 
            sPrep.innerHTML = "‚úÖ Chef is Preparing";
            sReady.innerHTML = "‚úÖ Food is Ready!";
            sPrep.classList.add('active'); 
            sReady.classList.add('active');
        }
    } 

    function clearTracking() { localStorage.removeItem('ovenx_last_order_id'); document.getElementById('tracking-overlay').style.display = 'none'; setScrollLock(false); }

    function checkUpsell(item) {
        const itemName = item.name.toLowerCase();
        const overlay = document.getElementById('upsell-overlay');
        const content = document.getElementById('upsell-body-content');
        const icon = document.getElementById('upsell-icon');
        overlay.style.display = 'none';
        content.innerHTML = `<p id="upsell-desc" style="font-weight:bold; color:#555; margin-bottom:20px;"></p><button id="upsell-yes-btn" class="confirm-btn btn-3d" style="margin-top:0; background:var(--orange); box-shadow: 0 6px 0px var(--dark-orange);">YES, ADD IT! üöÄ</button>`;
        if(itemName.includes('pizza') || itemName.startsWith('plain fries')) {
            icon.innerText = "üçØ"; document.getElementById('upsell-desc').innerHTML = "Add a **Dip Sauce** for only **Rs 50**!";
            document.getElementById('upsell-yes-btn').onclick = () => showDipFlavorGrid(false);
            overlay.style.display = 'flex'; setScrollLock(true);
        } else if (itemName.includes('club sandwich') || itemName.includes('burger')) {
            icon.innerText = "üçüü•§"; document.getElementById('upsell-desc').innerHTML = "Make it a **Combo Meal**!<br>Add Regular Fries + Buddy Drink for **Rs 360**.";
            document.getElementById('upsell-yes-btn').onclick = () => { addUpsellToCart("Combo Meal (Fries + Drink)", 360); overlay.style.display='none'; setScrollLock(false); };
            overlay.style.display = 'flex'; setScrollLock(true);
        } else if (itemName.includes('wings')) {
            icon.innerText = "üçóüî•"; document.getElementById('upsell-desc').innerHTML = "Make it a **Wings Combo**!<br>Add Sauce + Buddy Drink for only **Rs 180**.";
            document.getElementById('upsell-yes-btn').onclick = () => showDipFlavorGrid(true);
            overlay.style.display = 'flex'; setScrollLock(true);
        }
    }

    function showDipFlavorGrid(isWingsCombo) {
        const flavors = ["BBQ", "Peri Peri", "Bonfire", "Special", "Chipotle", "Creamy Dreamy", "Chili Mayo"];
        const content = document.getElementById('upsell-body-content');
        let html = `<p style="font-weight:900; color:var(--red);">PICK YOUR SAUCE:</p><div class="upsell-grid">`;
        flavors.forEach(f => {
            if(isWingsCombo) html += `<button class="upsell-flavor-btn btn-3d" onclick="addUpsellToCart('Dip: ${f}', 50); addUpsellToCart('Buddy Drink', 130); document.getElementById('upsell-overlay').style.display='none'; setScrollLock(false);">${f}</button>`;
            else html += `<button class="upsell-flavor-btn btn-3d" onclick="addUpsellToCart('Dip: ${f}', 50); document.getElementById('upsell-overlay').style.display='none'; setScrollLock(false);">${f}</button>`;
        });
        html += `</div>`; content.innerHTML = html;
    }

    function addUpsellToCart(name, price) { playClick('thud'); cart.push({ name: name, price: price, qty: 1, note: "Smart Add-on" }); updateCartBar(); }

        async function finalSubmitOrder() {
    playClick('thud'); const foodTotal = cart.reduce((s, i) => s + (i.price * i.qty), 0); let sc = (orderType === "Dine-In") ? Math.round(foodTotal * 0.07) : 0;
    const grand = foodTotal + sc + delCharge;
    const itemsText = cart.map(i => {
        let detail = i.qty + "x " + i.name;
        if (i.note) detail += " [" + i.note + "]"; 
        return detail;
    }).join("\n");

    const orderObj = { type: orderType, location: orderType === 'Dine-In' ? "Table " + tableNum : userAddress, items: itemsText, status: 'WAITING', subtotal: foodTotal + sc, delivery_fee: delCharge };
    
    let orderId = null;
    try { if(sb) { const { data } = await sb.from('kitchen_orders').insert([orderObj]).select(); if(data && data[0]) orderId = data[0].id; } } catch(e) { }

    let stamps = parseInt(localStorage.getItem('ovenx_stamps') || 0);
    let bonus = "";
    if(localStorage.getItem('ovenx_member_name')) {
        if(stamps >= 10) {
            const prize = LOYALTY_PRIZES[Math.floor(Math.random() * LOYALTY_PRIZES.length)];
            bonus = "\n\nüåü MEMBER GIFT CLAIMED: " + prize;
            localStorage.setItem('ovenx_stamps', 0);
        } else if(foodTotal >= 1000) {
            localStorage.setItem('ovenx_stamps', stamps + 1);
        }
    }

    let headerInfo = `*OVEN X - ${orderType.toUpperCase()} ORDER*`; 
    if (tableNum && orderType === 'Dine-In') headerInfo += `\n*TABLE: ${tableNum}*`;
    if (orderType === 'Delivery' && userAddress) headerInfo += `\nüìç *ADDRESS:* ${userAddress}`;

    const waMsg = encodeURIComponent(`${headerInfo}\n\n${itemsText}\n\nSubtotal: Rs ${foodTotal}${sc > 0 ? '\nS.C (7%): Rs ' + sc : ''}${delCharge > 0 ? '\nDelivery Charge: Rs ' + delCharge : ''}\n*Grand Total: Rs ${grand}*${bonus}`);
    
    cart = []; updateCartBar();
    document.getElementById('overlay-screen').style.display = 'none';
    if(orderId) initCustomerTracking(orderId);

    // ============================================
    // NEW: Dual WhatsApp for Delivery Orders
    // ============================================
    
    const KITCHEN_NUMBER = "923003450301";        // Bahawalpur Kitchen number
    const CUSTOMER_CARE_NUMBER = "923003450301";  // Same number for Bahawalpur

    if (orderType === 'Delivery') {
        // Delivery: Send to BOTH numbers
        
        // 1. Kitchen (main order) - same tab
        window.location.href = `https://wa.me/${KITCHEN_NUMBER}?text=${waMsg}`;
        
        // 2. Customer Care (copy) - new tab after delay
        setTimeout(() => {
            window.open(`https://wa.me/${CUSTOMER_CARE_NUMBER}?text=${waMsg}`, '_blank');
        }, 1500);
        
    } else {
        // Dine-in/Takeaway: Only to Kitchen (original behavior)
        window.location.href = `https://wa.me/${KITCHEN_NUMBER}?text=${waMsg}`;
    }
}

    function addToCartFinal() { 
        playClick('thud'); 
        const note = document.getElementById('special-note').value; 
        let finalDetail = (selectedItem.flavorNotes || "") + (selectedItem.fixedItems ? "\nIncludes: " + selectedItem.fixedItems.join(", ") : "") + (note ? "\nNote: " + note : ""); 
        const addedItem = { ...selectedItem, qty: selectedQty, note: finalDetail };
        cart.push(addedItem); updateCartBar(); closeModals(); 
        setTimeout(() => checkUpsell(addedItem), 300);
    }
    
    function updateCartBar() { const totalItems = cart.reduce((s, i) => s + i.qty, 0); const totalPrice = cart.reduce((s, i) => s + (i.price * i.qty), 0); document.getElementById('cart-count').innerText = `ITEMS: ${totalItems}`; document.getElementById('cart-total').innerText = `Rs ${totalPrice}`; document.getElementById('cart-bar').style.display = totalItems > 0 ? 'flex' : 'none'; }
    function removeItem(idx) { playClick('pop'); cart.splice(idx, 1); updateCartBar(); if(cart.length === 0) { document.getElementById('overlay-screen').style.display = 'none'; setScrollLock(false); } else renderFinalSummary(delCharge); }
    
    function startCheckout() { 
        playClick('thud'); 
        document.getElementById('overlay-screen').style.display = 'block'; 
        setScrollLock(true); 
        renderServiceTypeStep(); 
    }

    function closeCheckout() {
        playClick('pop');
        document.getElementById('overlay-screen').style.display = 'none';
        setScrollLock(false);
        chkStep = 1;
    }
    
    function renderServiceTypeStep() { 
        chkStep = 1; 
        document.getElementById('checkout-content').innerHTML = `<div class="chat-bubble">Where do you want your food?</div><div class="input-group" id="checkout-options-buttons"></div>`; 
        renderCheckoutServiceButtons(); 
    }
    
    function renderCheckoutServiceButtons() { 
        const container = document.getElementById('checkout-options-buttons'); 
        let html = `<button class="next-btn btn-3d" onclick="selectService('Dine-In')" style="background:#007bff; box-shadow: 0 6px 0px #0056b3;">üçΩÔ∏è Eat Here (7% SC)</button><button class="next-btn btn-3d" onclick="selectService('Takeaway')" style="background:#6c757d; box-shadow: 0 6px 0px #495057;">ü•° Take Home</button>`; 
        if (!isQRScan) { 
            html += `<button class="next-btn btn-3d" style="background:var(--red); box-shadow: 0 6px 0px var(--dark-red);" onclick="selectService('Delivery')">üöö Delivery</button>`; 
        } 
        container.innerHTML = html; 
    }
    
    function setInitialService(type) {
        playClick('pop');
        orderType = type;
        document.getElementById('welcome-overlay').style.display = 'none';
        setScrollLock(false);

        if (type === 'Dine-In') {
            if (tableNum) {
                renderFinalSummary(0);
            } else {
                renderTableStep();
            }
        } else if (type === 'Takeaway') {
            renderFinalSummary(0);
        } else if (type === 'Delivery') {
            renderAddressStep();
        }
    }
    
    function selectService(type) { playClick('pop'); orderType = type; if(type === 'Dine-In') { if(tableNum) renderFinalSummary(0); else renderTableStep(); } else if(type === 'Takeaway') renderFinalSummary(0); else renderAddressStep(); }
    function renderTableStep() { chkStep = 2; document.getElementById('checkout-content').innerHTML = `<div class="chat-bubble">What is your <b>Table Number</b>?</div><div class="input-group"><input type="text" id="manualTable" placeholder="Example: A1" class="big-input"><button class="next-btn btn-3d" style="background:var(--red); box-shadow:0 6px 0px var(--dark-red);" onclick="playClick('thud'); tableNum=document.getElementById('manualTable').value.toUpperCase(); renderFinalSummary(0)">NEXT</button></div>`; }
    
    // NEW: Delivery Calculator Integration
    function renderAddressStep() { 
        chkStep = 2; 
        document.getElementById('checkout-content').innerHTML = `
            <div class="chat-bubble">
                <b>üöö Delivery Setup</b><br>
                Click below to calculate your delivery charges automatically
            </div>
            <div class="delivery-center-wrap">
                <div class="delivery-cta btn-3d" onclick="playClick('pop'); openDeliveryCalc()">
                    <span style="font-size:50px;">üó∫Ô∏èüí®</span><br>
                    <span style="font-weight:900; color:var(--red);">CALCULATE DELIVERY FEE</span><br>
                    <small style="color:#666;">Auto-detect your location</small>
                </div>
            </div>
            <div id="delivery-fee-display" style="display:none; background:#e8f5e9; border:2px solid #4caf50; border-radius:15px; padding:15px; margin:15px 0; text-align:center;">
                <p style="margin:0; color:#2e7d32; font-weight:900;">‚úÖ Delivery Fee: Rs <span id="display-fee-amount">0</span></p>
                <p style="margin:5px 0 0; font-size:12px; color:#555;" id="display-distance-info"></p>
            </div>
            <button id="proceed-to-address" style="display:none; width:100%; padding:15px; background:#ccc; color:white; border:none; border-radius:15px; font-weight:900;" disabled>Enter Address ‚Üí</button>
        `; 
    }

    function openDeliveryCalc() {
        document.getElementById('delivery-calc-overlay').style.display = 'flex';
        setScrollLock(true);
        // Reset states
        document.getElementById('calc-permission-state').style.display = 'block';
        document.getElementById('calc-loading-state').style.display = 'none';
        document.getElementById('calc-result-state').style.display = 'none';
        document.getElementById('calc-error-state').style.display = 'none';
        currentCalcData = null;
    }

    function closeDeliveryCalc() {
        document.getElementById('delivery-calc-overlay').style.display = 'none';
        setScrollLock(false);
    }

    // Haversine Formula
    function calculateStraightDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    async function getRoadDistance(userLat, userLng) {
        try {
            const url = `https://router.project-osrm.org/route/v1/driving/${OVENX_COORDS.lng},${OVENX_COORDS.lat};${userLng},${userLat}?overview=false`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Routing service unavailable');
            const data = await response.json();
            if (data.code !== 'Ok' || !data.routes || !data.routes[0]) throw new Error('No route found');
            return data.routes[0].distance / 1000;
        } catch (error) {
            console.warn('OSRM failed, using estimation:', error);
            return null;
        }
    }

    function requestCalcLocation() {
        document.getElementById('calc-permission-state').style.display = 'none';
        document.getElementById('calc-loading-state').style.display = 'block';
        document.getElementById('calc-result-state').style.display = 'none';
        document.getElementById('calc-error-state').style.display = 'none';

        if (!navigator.geolocation) {
            showCalcError("Geolocation is not supported by your browser.");
            return;
        }

        navigator.geolocation.getCurrentPosition(
            handleCalcSuccess,
            handleCalcError,
            { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
    }

    async function handleCalcSuccess(position) {
        const userLat = position.coords.latitude;
        const userLng = position.coords.longitude;
        
        const roadDistance = await getRoadDistance(userLat, userLng);
        const straightDistance = calculateStraightDistance(OVENX_COORDS.lat, OVENX_COORDS.lng, userLat, userLng);
        
        const usedDistance = roadDistance || (straightDistance * 1.4);
        const roundTrip = usedDistance * 2;
        const cost = Math.ceil(roundTrip * PRICE_PER_KM);

        currentCalcData = {
            userLat, userLng,
            oneWay: usedDistance.toFixed(2),
            roundTrip: roundTrip.toFixed(2),
            straightLine: straightDistance.toFixed(2),
            cost: cost,
            isEstimated: !roadDistance,
            timestamp: new Date().toISOString()
        };

        // Save to database
        if (sb) {
            await sb.from('delivery_calculations').insert([{
                lat: userLat,
                lng: userLng,
                distance_one_way: usedDistance,
                distance_round_trip: roundTrip,
                cost: cost,
                is_estimated: !roadDistance
            }]);
        }

        // Show results
        document.getElementById('calc-loading-state').style.display = 'none';
        document.getElementById('calc-result-state').style.display = 'block';
        
        document.getElementById('calc-total-cost').innerText = cost;
        document.getElementById('calc-one-way').innerText = currentCalcData.oneWay + ' km' + (currentCalcData.isEstimated ? ' (est.)' : '');
        document.getElementById('calc-round-trip').innerText = currentCalcData.roundTrip + ' km';
        document.getElementById('calc-straight-line').innerText = currentCalcData.straightLine + ' km';

        // Auto-forward after 2 seconds
        setTimeout(() => {
            applyDeliveryFee(cost, currentCalcData);
        }, 2000);
    }

    function handleCalcError(error) {
        let msg = "Unable to retrieve your location.";
        switch(error.code) {
            case error.PERMISSION_DENIED:
                msg = "Location access denied. Please enable location permissions.";
                break;
            case error.POSITION_UNAVAILABLE:
                msg = "Location information unavailable.";
                break;
            case error.TIMEOUT:
                msg = "Location request timed out.";
                break;
        }
        showCalcError(msg);
    }

    function showCalcError(msg) {
        document.getElementById('calc-loading-state').style.display = 'none';
        document.getElementById('calc-error-state').style.display = 'block';
        document.getElementById('calc-error-msg').innerText = msg;
    }

    function applyDeliveryFee(fee, calcData) {
        delCharge = fee;
        closeDeliveryCalc();
        
        // Update checkout screen
        const feeDisplay = document.getElementById('delivery-fee-display');
        const proceedBtn = document.getElementById('proceed-to-address');
        
        if (feeDisplay && proceedBtn) {
            feeDisplay.style.display = 'block';
            document.getElementById('display-fee-amount').innerText = fee;
            document.getElementById('display-distance-info').innerText = 
                `Distance: ${calcData.oneWay} km one way | Round trip: ${calcData.roundTrip} km`;
            
            proceedBtn.style.display = 'block';
            proceedBtn.style.background = 'var(--orange)';
            proceedBtn.disabled = false;
            proceedBtn.onclick = () => {
                playClick('thud');
                renderDeliveryAddressInput();
            };
        } else {
            // Fallback if elements not found
            renderDeliveryAddressInput();
        }
    }

    function renderDeliveryAddressInput() {
        document.getElementById('checkout-content').innerHTML = `
            <div class="chat-bubble">
                <b>üè† Delivery Address</b><br>
                Delivery Fee: <span style="color:var(--red); font-weight:900;">Rs ${delCharge}</span>
            </div>
            <textarea id="manualAddr" placeholder="Enter your full address..." class="big-input" style="height:100px;"></textarea>
            <button class="next-btn btn-3d" style="background:var(--orange); box-shadow:0 6px 0px var(--dark-orange); margin-top:15px;" onclick="playClick('thud'); saveAddr()">SHOW SUMMARY ‚Üí</button>
        `;
    }

    function saveAddr() { 
        let a = document.getElementById('manualAddr').value; 
        if(!a) return alert("Please enter address!"); 
        userAddress = a; 
        renderFinalSummary(delCharge); 
    }

    let adminPassTracker = "";
    function openAdminLogin() { playClick('pop'); adminPassTracker = ""; document.getElementById('adminPassword').value = ""; document.getElementById('admin-login-overlay').style.display = 'flex'; setScrollLock(true); }
    function closeAdminLogin() { document.getElementById('admin-login-overlay').style.display = 'none'; setScrollLock(false); }
    function handlePassInput(el) { let cur = el.value; if(cur.length < adminPassTracker.length) adminPassTracker = adminPassTracker.substring(0, cur.length); else { let last = cur.substring(cur.length-1); if(last !== "üçï") adminPassTracker += last; } el.value = "üçï".repeat(adminPassTracker.length); }
    
    function verifyAdmin() { 
        const pass = adminPassTracker;
        if(pass === "123") {
            playClick('thud');
            closeAdminLogin();
            openKitchenPanel();
            if ("Notification" in window) Notification.requestPermission();
        } else {
            alert("Wrong Code!");
            adminPassTracker = "";
            document.getElementById('adminPassword').value = "";
        }
    }

    function renderFinalSummary(fee) {
        chkStep = 3; delCharge = parseFloat(fee) || 0; const foodTotal = cart.reduce((s, i) => s + (i.price * i.qty), 0); let sc = (orderType === "Dine-In") ? Math.round(foodTotal * 0.07) : 0; const grand = foodTotal + delCharge + sc;
        const summaryHTML = cart.map((i, idx) => `<div class="summary-item"><div class="summary-info"><b>${i.qty}x ${i.name}</b><br><small style="color:#666;">${i.note || ''}</small></div><div class="remove-item-btn btn-3d" onclick="removeItem(${idx})">üóëÔ∏è</div></div>`).join('');
        let summaryBubbleContent = `<b>ORDER SUMMARY</b>`; if (orderType === 'Delivery' && userAddress) summaryBubbleContent += `<br><small style="color:var(--red);">üìç Address: ${userAddress}</small>`;
        document.getElementById('checkout-content').innerHTML = `<div class="chat-bubble">${summaryBubbleContent}</div>${summaryHTML}<div class="chat-bubble">Subtotal: Rs ${foodTotal}${sc > 0 ? '<br>S.C: Rs '+sc : ''}${delCharge > 0 ? '<br>Delivery: Rs '+delCharge : ''}<br><hr>Total: <b>Rs ${grand}</b></div><button onclick="finalSubmitOrder()" class="confirm-btn btn-3d">ORDER VIA WHATSAPP</button>`;
    }

    /* --- LIVE KITCHEN LOGIC --- */
    async function updateStatus(id, newStatus) { playClick('thud'); if(sb) await sb.from('kitchen_orders').update({ status: newStatus }).eq('id', id); renderKitchenOrders(); }
    async function assignRider(id, rider) { playClick('pop'); if(sb) await sb.from('kitchen_orders').update({ rider: rider }).eq('id', id); renderKitchenOrders(); }
    async function clearReadyOrders() { if(!confirm("Clear Ready Dine-In orders?")) return; playClick('pop'); if(!sb) return; const { data: ready } = await sb.from('kitchen_orders').select('id').eq('status', 'READY').neq('type', 'Delivery'); if(ready && ready.length > 0) { await sb.from('kitchen_orders').delete().in('id', ready.map(o => o.id)); renderKitchenOrders(); } }

    async function clearDeliveriesWithPassword() {
        const p = prompt("Enter Audit Code to Clear ALL Deliveries:");
        if(p === "7530") {
            playClick('thud'); if(!sb) return;
            const { error } = await sb.from('kitchen_orders').delete().eq('type', 'Delivery');
            if(!error) { alert("Delivery Audit Cleared!"); renderKitchenOrders(); } else alert("Error clearing database.");
        } else if (p !== null) { alert("Denied! Wrong Password."); }
    }
    
    function setKitchenFilter(f) {
        currentKitchenFilter = f; 
        playClick('pop'); 
        document.querySelectorAll('.k-tab').forEach(t => t.classList.remove('active'));
        
        // Hide all sidebars first
        document.getElementById('rider-audit-sidebar').style.display = 'none';
        document.getElementById('delivery-history-sidebar').style.display = 'none';
        document.getElementById('clear-del-btn').style.display = 'none';
        
        if(f === 'ALL') { 
            document.getElementById('k-tab-all').classList.add('active'); 
        } else if (f === 'DELIVERY') { 
            document.getElementById('k-tab-del').classList.add('active'); 
            document.getElementById('rider-audit-sidebar').style.display = 'flex'; 
            document.getElementById('clear-del-btn').style.display = 'block'; 
        } else if (f === 'CALC_HISTORY') {
            document.getElementById('k-tab-calc').classList.add('active');
            document.getElementById('delivery-history-sidebar').style.display = 'flex';
            loadDeliveryHistory();
        }
        renderKitchenOrders();
    }

    async function loadDeliveryHistory() {
    if (!sb) return;
    
    const { data, error } = await sb.from('delivery_calculations')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(50);
        
    const list = document.getElementById('delivery-history-list');
    const count = document.getElementById('calc-history-count');
    
    if (error) {
        list.innerHTML = '<p style="text-align:center; color:#c62828;">Error loading history</p>';
        return;
    }
    
    count.innerText = data ? data.length : 0;
    
    if (!data || data.length === 0) {
        list.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">No calculations yet</p>';
        return;
    }
    
    list.innerHTML = data.map(calc => {
        const date = new Date(calc.created_at).toLocaleString('en-PK', {
            day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
        });
        return `
            <div class="delivery-history-card">
                <div class="distance-badge">${calc.distance_one_way.toFixed(1)} km</div>
                <div class="loc-text">
                    üìç Lat: ${calc.lat.toFixed(4)}, Lng: ${calc.lng.toFixed(4)}
                    ${calc.is_estimated ? '<span style="color:#ff9800; font-size:10px;"> (ESTIMATED)</span>' : ''}
                </div>
                <button onclick="openInGoogleMaps(${calc.lat}, ${calc.lng})" class="btn-3d" style="background:var(--wa-green); color:white; border:none; padding:8px 15px; border-radius:10px; font-weight:900; font-size:11px; margin:8px 0; width:100%; box-shadow:0 4px 0px var(--wa-dark);">
                    üó∫Ô∏è OPEN IN GOOGLE MAPS
                </button>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span class="cost-highlight">Rs ${calc.cost}</span>
                    <span style="font-size:11px; color:#666;">${date}</span>
                </div>
                <div class="meta-row">
                    <span>Round: ${calc.distance_round_trip.toFixed(2)} km</span>
                    <span>Rate: Rs 12/km</span>
                </div>
            </div>
        `;
    }).join('');
}

    async function clearDeliveryHistory() {
        if (!confirm("Clear all delivery calculation history?")) return;
        if (!sb) return;
        
        const { error } = await sb.from('delivery_calculations')
            .delete()
            .neq('id', '00000000-0000-0000-0000-000000000000'); // Delete all
            
        if (!error) {
            loadDeliveryHistory();
            playClick('thud');
        }
    }
// ADD IT HERE - right after clearDeliveryHistory()
    function openInGoogleMaps(lat, lng) {
        playClick('pop');
        const url = `https://www.google.com/maps?q=${lat},${lng}`;
        window.open(url, '_blank');
    }

    function openKitchenPanel() { 
        document.getElementById('kitchen-panel-overlay').style.display = 'flex'; 
        renderKitchenOrders(); 
        if(!kitchenInterval) kitchenInterval = setInterval(renderKitchenOrders, 1000); 
        setScrollLock(true); 
    }

    function openKitchenPanel() { 
        document.getElementById('kitchen-panel-overlay').style.display = 'flex'; 
        renderKitchenOrders(); 
        if(!kitchenInterval) kitchenInterval = setInterval(renderKitchenOrders, 1000); 
        setScrollLock(true); 
    }
    
    function closeKitchenPanel() { 
        document.getElementById('kitchen-panel-overlay').style.display = 'none'; 
        if(kitchenInterval) { clearInterval(kitchenInterval); kitchenInterval = null; } 
        setScrollLock(false); 
    }
    
    async function downloadCustomerData() {
        if(!confirm("Download Customer Database?")) return;
        const { data, error } = await sb.from('gold_club_members').select('name, phone, created_at');
        if(error) return alert("Error fetching data");
        
        let csvContent = "data:text/csv;charset=utf-8,Name,WhatsApp,Date Joined\n";
        data.forEach(row => {
            csvContent += `${row.name},${row.phone},${new Date(row.created_at).toLocaleDateString()}\n`;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `OvenX_Club_Members_${new Date().toLocaleDateString()}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function openManualOrderModal() { document.getElementById('manual-order-overlay').style.display = 'flex'; setScrollLock(true); }
    
    async function saveManualOrder() {
        const type = document.getElementById('man-type').value;
        const loc = document.getElementById('man-loc').value;
        const items = document.getElementById('man-items').value;
        const sub = parseInt(document.getElementById('man-sub').value || 0);
        const fee = parseInt(document.getElementById('man-fee').value || 0);
        if(!loc || !items) return alert("Please fill Table/Address and Items list!");
        const obj = { type: type, location: loc, items: items, status: 'WAITING', subtotal: sub, delivery_fee: fee };
        if(sb) {
            playClick('thud');
            const { error } = await sb.from('kitchen_orders').insert([obj]);
            if(!error) {
                document.getElementById('manual-order-overlay').style.display = 'none';
                setScrollLock(false);
                renderKitchenOrders();
                document.getElementById('man-loc').value = "";
                document.getElementById('man-items').value = "";
                document.getElementById('man-sub').value = "";
                document.getElementById('man-fee').value = "";
            } else alert("Error saving manual order.");
        }
    }

const CUSTOMER_CARE_NUMBER = '923003450301';

function formatCCMessage(order) {
    const total = (order.subtotal || 0) + (order.delivery_fee || 0);
    
    return `*Order Confirmed*\n\n` +
           `*Delivery Order*\n` +
           `${order.location}\n\n` +
           `${order.items}\n\n` +
           `Bill: Rs ${order.subtotal || 0}\n` +
           `Delivery: Rs ${order.delivery_fee || 0}\n` +
           `*Total: Rs ${total}*`;
}

function sendToCC(orderId, items, location, subtotal, deliveryFee, createdAt, btnElement) {
    playClick('thud');
    
    // Reconstruct order object
    const order = {
        id: orderId,
        items: items,
        location: location,
        subtotal: parseInt(subtotal) || 0,
        delivery_fee: parseInt(deliveryFee) || 0,
        created_at: createdAt
    };
    
    const message = encodeURIComponent(formatCCMessage(order));
    const url = `https://wa.me/${CUSTOMER_CARE_NUMBER}?text=${message}`;
    
    // Open WhatsApp
    window.open(url, '_blank');
    
    // Visual feedback - use the passed button element
    if (btnElement) {
        const originalText = btnElement.innerHTML;
        btnElement.innerHTML = '‚úÖ OPENED!';
        btnElement.style.background = '#28a745';
        btnElement.disabled = true;
        
        setTimeout(() => {
            btnElement.innerHTML = originalText;
            btnElement.style.background = '#25D366';
            btnElement.disabled = false;
        }, 3000);
    }
}
    async function renderKitchenOrders() {
        if(!sb) return; 
        
        // Only render orders list if not on calc history tab
        if (currentKitchenFilter !== 'CALC_HISTORY') {
            let query = sb.from('kitchen_orders').select('*').order('created_at', { ascending: false });
            if(currentKitchenFilter === 'DELIVERY') query = query.eq('type', 'Delivery');
            const { data: orders } = await query; 
            const list = document.getElementById('kitchen-orders-list');
            list.innerHTML = (!orders || orders.length === 0) ? "<p style='padding:20px; text-align:center; color:#999;'>NO ACTIVE ORDERS</p>" : "";
            const now = new Date(); 
            let isAnyOrderLate = false;
            orders && orders.forEach((o) => {
                const createdAt = new Date(o.created_at); 
                const remaining = (25 * 60000) - (now - createdAt);
                let timeLabel = ""; 
                let alertClass = "";
                if (o.status !== 'READY') { 
                    if (remaining <= 0) { 
                        alertClass = "late"; 
                        timeLabel = "LATE"; 
                        isAnyOrderLate = true; 
                    } else { 
                        timeLabel = Math.floor(remaining/60000) + ":" + Math.floor((remaining%60000)/1000).toString().padStart(2,'0'); 
                        if (remaining <= 5 * 60000) alertClass = "warning"; 
                    } 
                }
                let priceHtml = ""; 
                if (o.subtotal) priceHtml = `<div class="price-box"><div>Shop: Rs ${o.subtotal} | Del: Rs ${o.delivery_fee || 0}</div><div style="color:var(--red); font-size:18px;">Total: Rs ${(o.subtotal + (o.delivery_fee || 0))}</div></div>`;
                let riderHtml = ""; 
                if(o.type === 'Delivery') riderHtml = `<div class="rider-box"><span style="font-size:11px; font-weight:900; color:#888;">ASSIGN RIDER:</span><div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;">${RIDERS.map(r => `<button class="rider-btn ${o.rider === r ? 'selected' : ''}" onclick="assignRider('${o.id}', '${r}')">${r}</button>`).join('')}</div></div>`;
                const card = document.createElement('div'); 
                card.className = `kitchen-card status-${o.status.toLowerCase()} ${alertClass}`;
                card.innerHTML = `<span class="kitchen-badge kb-${o.status.toLowerCase()}">${o.status}</span><div style="font-weight:900; color:var(--red); font-size:18px;">${o.type.toUpperCase()} - ${o.location}</div><div class='order-timer'>${timeLabel}</div><div style="white-space:pre-wrap; font-weight:600; font-size:14px; background:#f9f9f9; padding:10px; border-radius:15px; margin-top:10px;">${o.items}</div>
                ${priceHtml}
                <div class="admin-actions">
                    <button class="btn-action btn-void-item" onclick="adminVoidItem('${o.id}', \`${o.items.replace(/`/g, "\\'")}\`, ${o.subtotal || 0})">VOID ITEM</button>
                    <button class="btn-action btn-recall" onclick="adminRecallItem('${o.id}', \`${o.items.replace(/`/g, "\\'")}\`, ${o.subtotal || 0})">RECALL</button>
                    <button class="btn-action btn-table" onclick="adminChangeTable('${o.id}', '${o.location.replace(/'/g, "\\'")}')">CHG TABLE</button>
                    <button class="btn-action btn-void-order" onclick="adminVoidOrder('${o.id}')">VOID ALL</button>
                    <button class="btn-action btn-print-front" onclick="printOrderData('${o.id}', 'front')">üñ®Ô∏è FRONT</button>
                    <button class="btn-action btn-print-kitchen" onclick="printOrderData('${o.id}', 'kitchen')">üç≥ KITCHEN</button>
${o.type === 'Delivery' ? `<button class="btn-action btn-send-cc" onclick="sendToCC('${o.id}', \`${o.items.replace(/`/g, "\\'")}\`, '${o.location.replace(/'/g, "\\'")}', ${o.subtotal || 0}, ${o.delivery_fee || 0}, '${o.created_at}', this)">üì± SEND TO CC</button>` : ''}                </div>
                ${riderHtml}
                <div style="display:flex; gap:10px; margin-top:15px;">
                    ${o.status === 'WAITING' ? `<button class="next-btn" style="background:#007bff; border-radius:12px; flex:1;" onclick="updateStatus('${o.id}', 'PREPARING')">PREPARING</button>` : ''}
                    ${o.status === 'PREPARING' ? `<button class="next-btn" style="background:var(--wa-green); border-radius:12px; flex:1;" onclick="updateStatus('${o.id}', 'READY')">MARK READY ‚úÖ</button>` : ''}
                </div>`;
                list.appendChild(card);
            });
            if(isAnyOrderLate) playClick('siren');
            if(currentKitchenFilter === 'DELIVERY') renderAuditUI(orders);
        }
    }

            async function printOrderData(id, type) {
        if (!sb) return alert("Database connection error");
        const { data: o, error } = await sb.from('kitchen_orders').select('*').eq('id', id).single();
        if (error || !o) return alert("Error loading order.");

        const printArea = document.getElementById('print-area');
        const dateTime = new Date(o.created_at).toLocaleString('en-PK', {
            day: 'numeric', month: 'short', year: 'numeric',
            hour: '2-digit', minute: '2-digit', hour12: true
        }).replace(',', '');

        const delFee = o.delivery_fee || 0;
        
        // Helper: Get price for regular menu items
        const getMenuItemPrice = (itemName) => {
            // Extract size from parentheses: "Extreme Peri Peri (M)" ‚Üí "M"
            const sizeMatch = itemName.match(/\(([^)]+)\)/);
            const size = sizeMatch ? sizeMatch[1] : null;
            const baseName = itemName.replace(/\s*\([^)]+\)\s*$/, '').trim();
            
            for (let cat in menuData) {
                const item = menuData[cat].find(i => i.name === baseName || baseName.includes(i.name) || i.name.includes(baseName));
                if (item) {
                    if (typeof item.price === 'object') {
                        if (size && item.price[size]) return item.price[size];
                        // Try to match common size variations
                        const sizeMap = { 'Med': 'M', 'Medium': 'M', 'Large': 'L', 'Regular': 'Reg' };
                        if (size && sizeMap[size] && item.price[sizeMap[size]]) return item.price[sizeMap[size]];
                        // Fallback to first price
                        return Object.values(item.price)[0];
                    }
                    return item.price;
                }
            }
            return null; // Not found in menu
        };

        // Helper: Get price for deals
        const getDealPrice = (dealName) => {
            const deal = dealsData.find(d => dealName.includes(d.name));
            return deal ? deal.price : null;
        };

        // Parse items and calculate totals
        let itemsHtml = "";
        let calculatedFoodSub = 0;
        
        const lines = o.items.split('\n');
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            // Check if it's a main item line (starts with number + x)
            const mainMatch = line.match(/^(\d+)x\s+(.+?)(?:\s+\[(.*)\])?$/);
            
            if (mainMatch) {
                const qty = parseInt(mainMatch[1]);
                const name = mainMatch[2].trim();
                const note = mainMatch[3] || "";
                
                let unitPrice = 0;
                let lineTotal = 0;
                
                // Try to get price from deals first
                const dealPrice = getDealPrice(name);
                
                if (dealPrice !== null) {
                    // It's a deal - use deal price directly
                    unitPrice = dealPrice;
                    lineTotal = qty * unitPrice;
                    
                    // Add deal line
                    itemsHtml += `
                        <div style="display: flex; justify-content: space-between; font-weight: bold; margin-top: 5px;">
                            <span>${qty} x ${name}</span>
                            <span>${lineTotal}</span>
                        </div>
                    `;
                    
                    // Add flavor notes and includes (next lines until next main item)
                    let j = i + 1;
                    while (j < lines.length && !lines[j].match(/^\d+x\s+/)) {
                        const detailLine = lines[j].trim();
                        if (detailLine && !detailLine.startsWith('Note:')) {
                            itemsHtml += `<div style="font-size: 11px; padding-left: 15px; color: #555;">‚Ü≥ ${detailLine}</div>`;
                        }
                        j++;
                    }
                    
                    if (note) {
                        itemsHtml += `<div style="font-size: 11px; padding-left: 15px; color: #444;">‚Ü≥ ${note}</div>`;
                    }
                    
                } else {
                    // It's a regular menu item
                    const menuPrice = getMenuItemPrice(name);
                    
                    if (menuPrice !== null) {
                        unitPrice = menuPrice;
                        lineTotal = qty * unitPrice;
                        
                        itemsHtml += `
                            <div style="display: flex; justify-content: space-between; font-weight: bold; margin-top: 5px;">
                                <span>${qty} x ${name}</span>
                                <span>${lineTotal}</span>
                            </div>
                        `;
                        
                        if (note) {
                            itemsHtml += `<div style="font-size: 11px; padding-left: 15px; color: #444;">‚Ü≥ ${note}</div>`;
                        }
                    } else {
                        // Manual item or unknown - show as-is without price
                        itemsHtml += `
                            <div style="display: flex; justify-content: space-between; font-weight: bold; margin-top: 5px;">
                                <span>${qty} x ${name}</span>
                                <span>-</span>
                            </div>
                        `;
                        if (note) {
                            itemsHtml += `<div style="font-size: 11px; padding-left: 15px; color: #444;">‚Ü≥ ${note}</div>`;
                        }
                    }
                }
                
                calculatedFoodSub += lineTotal;
                
            } else if (!line.match(/^(Pizza|Includes|Flavor|Note):/i)) {
                // Non-item lines that aren't details
                itemsHtml += `<div style="font-size: 13px; color: #666; margin-top: 5px;">${line}</div>`;
            }
        }

        // Use calculated subtotal or fallback to stored value
        const foodSub = calculatedFoodSub > 0 ? calculatedFoodSub : (o.subtotal || 0);
        
        // Calculate service charge on food subtotal only
        const serviceCharge = (o.type === 'Dine-In') ? Math.round(foodSub * 0.07) : 0;
        
        // Grand total
        const grandTotal = foodSub + serviceCharge + delFee;

        // ... rest of the receipt HTML (same as before) ...
        if (type === 'front') {
            printArea.innerHTML = `
                <div style="text-align: center; font-family: 'Courier New', Courier, monospace; color: black; padding: 10px;">
                    <div style="font-weight: bold; font-size: 12px; margin-bottom: 5px;">*** PROVE BILL ***</div>
                    <div style="margin-bottom: 10px;">
                        <h1 style="margin: 0; font-size: 32px; letter-spacing: 2px; font-weight: 900;">OVEN <span style="color: #000;">X</span></h1>
                        <div style="font-size: 12px; font-weight: bold; border-top: 1px solid #000; border-bottom: 1px solid #000; display: inline-block; padding: 2px 10px; margin-top: 2px;">BAHAWALPUR BRANCH</div>
                    </div>
                    <div style="font-size: 12px; margin-bottom: 10px; line-height: 1.4;">
                        Shop number 8-9, SS Tower, 31-32 Noor Mahal Rd, Sadiq Colony, Bahawalpur, 63100<br>
                        Phone: 0300-3450301<br>
                        -----------------------------------
                    </div>
                    <div style="text-align: left; font-size: 13px; line-height: 1.5;">
                        <b>Bill No:</b> ${o.id.slice(0, 8).toUpperCase()}<br>
                        <b>Date  :</b> ${dateTime}<br>
                        <b>Table :</b> ${o.location}<br>
                        <b>Type  :</b> ${o.type}
                    </div>
                    <div style="border-bottom: 2px solid #000; margin: 10px 0 5px 0;"></div>
                    <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 14px;">
                        <span>Item Description</span>
                        <span>Price</span>
                    </div>
                    <div style="border-bottom: 1px solid #000; margin-bottom: 5px;"></div>
                    <div style="text-align: left;">${itemsHtml}</div>
                    <div style="border-bottom: 1px dashed #000; margin: 10px 0;"></div>
                    <div style="font-size: 14px; line-height: 1.6;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>Net Total:</span> <span>Rs ${foodSub}</span>
                        </div>
                        ${serviceCharge > 0 ? `<div style="display: flex; justify-content: space-between;"><span>Service Charges (7%):</span> <span>Rs ${serviceCharge}</span></div>` : ""}
                        ${delFee > 0 ? `<div style="display: flex; justify-content: space-between;"><span>Delivery Fee:</span> <span>Rs ${delFee}</span></div>` : ""}
                        <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; margin-top: 5px; border-top: 1px solid #000; padding-top: 5px;">
                            <span>Grand Total:</span> <span>Rs ${grandTotal}</span>
                        </div>
                    </div>
                    <div style="border-bottom: 1px dashed #000; margin: 15px 0 10px 0;"></div>
                    <div style="font-size: 14px; font-weight: bold;">
                        CASH RECEIVED: Rs ${grandTotal}<br>
                        CASH REFUND: Rs 0
                    </div>
                    <div style="margin-top: 20px; font-size: 12px;">
                        <b>Thank You For Visiting Us!</b><br>
                        Official System: OvenX.pk
                    </div>
                </div>
            `;
        } else {
            printArea.innerHTML = `
                <div style="text-align: center; font-family: sans-serif; color: black;">
                    <h2 style="margin: 0; border-bottom: 2px solid #000;">KITCHEN TICKET</h2>
                    <h1 style="margin: 5px 0;">${o.location}</h1>
                    <div style="font-size: 18px; font-weight: bold; background: #000; color: #fff;">${o.type.toUpperCase()}</div>
                    <div style="text-align: left; font-size: 20px; font-weight: bold; margin-top: 15px; white-space: pre-wrap;">${o.items}</div>
                    <div style="margin-top: 20px; border-top: 1px solid #000; padding-top: 10px;">
                        Time: ${new Date(o.created_at).toLocaleTimeString()}
                    </div>
                </div>
            `;
        }

        setTimeout(() => {
            window.print();
            printArea.innerHTML = "";
        }, 400);
    }

    function renderAuditUI(orders) {
        const div = document.getElementById('rider-audit-selection'); 
        div.innerHTML = "";
        RIDERS.forEach(r => {
            const b = document.createElement('button'); 
            b.className = "rider-btn"; 
            b.innerText = r;
            b.onclick = () => {
                const rOrders = orders.filter(o => o.rider === r);
                const cash = rOrders.reduce((s,o) => s + (o.subtotal || 0) + (o.delivery_fee || 0), 0);
                const fees = rOrders.reduce((s,o) => s + (o.delivery_fee || 0), 0);
                document.getElementById('audit-result-box').style.display = 'block'; 
                document.getElementById('audit-rider-name').innerText = r;
                document.getElementById('audit-count').innerText = rOrders.length; 
                document.getElementById('audit-cash').innerText = "Rs " + cash;
                document.getElementById('audit-fees').innerText = "Rs " + fees; 
                document.getElementById('audit-net').innerText = "Rs " + (cash - fees);
                playClick('pop');
            };
            div.appendChild(b);
        });
    }

    async function adminVoidOrder(id) { if(!confirm("Delete order?")) return; playClick('thud'); await sb.from('kitchen_orders').delete().eq('id', id); renderKitchenOrders(); }
    async function adminChangeTable(id, currentLoc) { const nl = prompt("New Table/Address:", currentLoc); if(nl) { playClick('pop'); await sb.from('kitchen_orders').update({ location: nl }).eq('id', id); renderKitchenOrders(); } }
    async function adminRecallItem(id, items, sub) { const ni = prompt("Add item:"); const pr = prompt("Price:"); if(ni) { playClick('thud'); const updatedItems = items + "\n" + ni + " [RECALL]"; const updatedSub = parseInt(sub || 0) + parseInt(pr || 0); await sb.from('kitchen_orders').update({ items: updatedItems, subtotal: updatedSub }).eq('id', id); renderKitchenOrders(); } }
    async function adminVoidItem(id, items, sub) { 
        const arr = items.split('\n').filter(line => line.trim()); 
        if (arr.length === 0) return alert("No items to void");
        let msg = "Select Line # to Void:\n\n"; 
        arr.forEach((it, i) => msg += `${i+1}. ${it.trim()}\n`);
        const ch = prompt(msg); 
        const idx = parseInt(ch) - 1;
        if(isNaN(idx) || idx < 0 || idx >= arr.length) return alert("Invalid choice");
        const ps = prompt(`Subtract price for: "${arr[idx].trim()}"?`, "0");
        playClick('thud'); arr.splice(idx, 1); 
        const updatedSub = Math.max(0, parseInt(sub || 0) - parseInt(ps || 0));
        await sb.from('kitchen_orders').update({ items: arr.join('\n'), subtotal: updatedSub }).eq('id', id); renderKitchenOrders();
    }

    function renderPublicDeals() {
        const list = document.getElementById('deals-list'); 
        list.innerHTML = '';
        dealsData.forEach(deal => {
            const card = document.createElement('div'); 
            card.className = "deal-card";
            card.innerHTML = `
                <div class="deal-badge">${deal.badge || 'HOT'}</div>
                <div class="deal-img-top" style="background-image: url('${deal.image}')"></div>
                <div class="deal-info-box">
                    <div class="deal-title">${deal.name}</div>
                    <span class="deal-desc">${deal.desc || ''}</span>
                    <span class="deal-price">Rs ${deal.price}</span>
                </div>
            `;
            const btn = document.createElement('button'); 
            btn.className = "next-btn btn-3d"; 
            btn.style.cssText = "background:var(--orange); box-shadow:0 6px 0px var(--dark-orange); margin-bottom:0;"; 
            btn.innerText = "ADD TO BAG";
            btn.onclick = () => openOrderFlow(deal); 
            card.querySelector('.deal-info-box').appendChild(btn);
            list.appendChild(card);
        });
    }

    function renderPublicMenu(filterText = "") {
        const mC = document.getElementById('menu-container'); 
        mC.innerHTML = ""; 
        const search = filterText.toLowerCase();
        for (let cat in menuData) {
            if (cat === "Pan/Premium") continue;
            const filteredItems = menuData[cat].filter(item => item.name.toLowerCase().includes(search) || cat.toLowerCase().includes(search));
            if (filteredItems.length > 0) {
                let title = document.createElement('div'); 
                title.className = 'section-title'; 
                title.innerText = cat; 
                title.id = "cat-" + cat.replace(/\s+/g, '-'); 
                mC.appendChild(title);
                let grid = document.createElement('div'); 
                grid.className = 'grid';
                filteredItems.forEach(item => {
                    let fBg = imgMap["pizza"];
                    let itemNameLower = item.name.toLowerCase();
                    
                    if (itemNameLower.includes('plain fries')) fBg = imgMap["plain fries"];
                    else if (itemNameLower.includes('loaded fries')) fBg = imgMap["loaded fries"];
                    else if (itemNameLower.includes('pizza fries')) fBg = imgMap["pizza fries"];
                    else if (itemNameLower.includes('dragon')) fBg = imgMap["dragon shots"];
                    else if (itemNameLower.includes('cheese sticks')) fBg = imgMap["cheese sticks"];
                    else if (itemNameLower.includes('meat sticks')) fBg = imgMap["meat sticks"];
                    else if (itemNameLower.includes('nuggets')) fBg = imgMap["nuggets"];
                    else if (itemNameLower.includes('zinger') && !itemNameLower.includes('roll')) fBg = imgMap["zinger"];
                    else if (itemNameLower.includes('chicken patty')) fBg = imgMap["chicken patty"];
                    else if (itemNameLower.includes('mighty')) fBg = imgMap["mighty"];
                    else if (itemNameLower.includes('chipotle') && itemNameLower.includes('burger')) fBg = imgMap["chipotle"];
                    else if (itemNameLower.includes('crispy jalapeno')) fBg = imgMap["crispy jalapeno"];
                    else if (itemNameLower.includes('stuff jalapeno')) fBg = imgMap["stuff jalapeno"];
                    else if (itemNameLower.includes('peri') && itemNameLower.includes('grilled')) fBg = imgMap["peri peri grilled"];
                    else if (itemNameLower.includes('smokey') || itemNameLower.includes('smoky')) fBg = imgMap["smokey grilled"];
                    else if (itemNameLower.includes('jalapeno blaze')) fBg = imgMap["jalapeno blaze"];
                    else if (itemNameLower.includes('mexi')) fBg = imgMap["mexi fiesta"];
                    else if (itemNameLower.includes('health')) fBg = imgMap["health harvest"];
                    else if (itemNameLower.includes('khameera')) fBg = imgMap["khameera"];
                    else if (itemNameLower.includes('club sandwich')) fBg = imgMap["club sandwich"];
                    else if (itemNameLower.includes('tikka')) fBg = imgMap["chicken tikka"];
                    else if (itemNameLower.includes('fajita')) fBg = imgMap["chicken fajita"];
                    else if (itemNameLower.includes('supreme')) fBg = imgMap["chicken supreme"];
                    else if (itemNameLower.includes('cheese lover')) fBg = imgMap["cheese lover"];
                    else if (itemNameLower.includes('veg lover')) fBg = imgMap["veg lover"];
                    else if (itemNameLower.includes('sicilian')) fBg = imgMap["sicilian"];
                    else if (itemNameLower.includes('bbq') && itemNameLower.includes('pizza')) fBg = imgMap["bbq"];
                    else if (itemNameLower.includes('creamy dreamy')) fBg = imgMap["creamy dreamy"];
                    else if (itemNameLower.includes('deep dish') || itemNameLower.includes('mild butter')) fBg = imgMap["mild butter"];
                    else if (itemNameLower.includes('extreme')) fBg = imgMap["extreme peri"];
                    else if (itemNameLower.includes('crown crust')) fBg = imgMap["crown crust"];
                    else if (itemNameLower.includes('cheese crust')) fBg = imgMap["cheese crust"];
                    else if (itemNameLower.includes('crusti thin')) fBg = imgMap["crusti thin"];
                    else if (itemNameLower.includes('calzone')) fBg = imgMap["calzone"];
                    else if (itemNameLower.includes('alfredo')) fBg = imgMap["alfredo"];
                    else if (itemNameLower.includes('chipotle wrap')) fBg = imgMap["chipotle wrap"];
                    else if (itemNameLower.includes('bbq wrap')) fBg = imgMap["bbq wrap"];
                    else if (itemNameLower.includes('crunch wrap')) fBg = imgMap["crunch wrap"];
                    else if (itemNameLower.includes('zingeratha')) fBg = imgMap["zingeratha"];
                    else if (itemNameLower.includes('paratha roll')) fBg = imgMap["paratha"];
                    else if (itemNameLower.includes('malai roll')) fBg = imgMap["malai"];
                    else if (itemNameLower.includes('peri wrap')) fBg = imgMap["peri wrap"];
                    else if (itemNameLower.includes('doner')) fBg = imgMap["doner"];
                    else if (itemNameLower.includes('wings') || itemNameLower.includes('wing')) {
                        if (itemNameLower.includes('peri')) fBg = imgMap["peri-peri wings"];
                        else if (itemNameLower.includes('hot')) fBg = imgMap["hot wings"];
                        else if (itemNameLower.includes('honey')) fBg = imgMap["honey chili wings"];
                        else fBg = imgMap["oven baked wings"];
                    }
                    else {
                        for (let key in imgMap) {
                            if (itemNameLower.includes(key.toLowerCase())) {
                                fBg = imgMap[key];
                                break;
                            }
                        }
                    }
                    
                    let b = document.createElement('div'); 
                    b.className = 'btn btn-3d'; 
                    b.style.backgroundImage = `url('${fBg}')`;
                    b.innerHTML = `<div class="item-label-box"><div>${item.name}</div><div class="price-tag">${typeof item.price === 'object' ? 'PICK SIZE' : 'Rs '+item.price}</div></div>`;
                    b.onclick = () => openOrderFlow(item); 
                    grid.appendChild(b);
                }); 
                mC.appendChild(grid);
            }
        } 
        renderCategoryBar();
    }
    
    function renderCategoryBar() {
        const bar = document.getElementById('category-bar'); 
        bar.innerHTML = "";
        for (let cat in menuData) {
            if (cat === "Pan/Premium") continue; 
            const pill = document.createElement('div'); 
            pill.className = "cat-pill"; 
            pill.innerText = cat;
            pill.onclick = () => { 
                document.querySelectorAll('.cat-pill').forEach(p => p.classList.remove('active')); 
                pill.classList.add('active'); 
                const t = document.getElementById("cat-" + cat.replace(/\s+/g, '-')); 
                if(t) t.scrollIntoView({ behavior: 'smooth' }); 
            }; 
            bar.appendChild(pill);
        }
    }

    function handleSearch(val) { renderPublicMenu(val); if (val === "") document.querySelectorAll('.cat-pill').forEach(p => p.classList.remove('active')); }
    
    function setupRealtimeNotifications() {
        if(!sb) return;
        
        if ("Notification" in window && Notification.permission === "default") {
            Notification.requestPermission();
        }
        
        sb.channel('kitchen-dashboard')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'kitchen_orders' }, (payload) => {
            playClick('siren');
            
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification("üî• NEW ORDER RECEIVED!", {
                    body: `Type: ${payload.new.type}\nLocation: ${payload.new.location}`,
                    icon: "https://cdn-icons-png.flaticon.com/512/5973/5973307.png",
                    badge: "https://cdn-icons-png.flaticon.com/512/5973/5973307.png",
                    tag: 'new-order',
                    requireInteraction: true
                });
            }
            
            if(document.getElementById('kitchen-panel-overlay').style.display === 'flex') {
                renderKitchenOrders();
            }
        }).subscribe();
    }

    // Global Initialization
    renderPublicMenu(); 
    renderPublicDeals(); 
    renderLoyaltyCard();
    setupRealtimeNotifications();
    const savedOrderId = localStorage.getItem('ovenx_last_order_id');
    if(savedOrderId) initCustomerTracking(savedOrderId);
    let deferredPrompt; 
    let secretClickCount = 0;
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; });
    function handleSecretClick() { 
        secretClickCount++; 
        if(secretClickCount === 5) { 
            secretClickCount = 0; 
            if (deferredPrompt) deferredPrompt.prompt(); 
            else alert("Ready."); 
        } 
        setTimeout(() => { secretClickCount = 0; }, 2000); 
    }
    
    window.addEventListener('popstate', function(event) {
        const overlays = [
            { id: 'loyalty-setup-overlay', close: () => { document.getElementById('loyalty-setup-overlay').style.display = 'none'; setScrollLock(false); } },
            { id: 'admin-login-overlay', close: closeAdminLogin },
            { id: 'kitchen-panel-overlay', close: closeKitchenPanel },
            { id: 'flavor-overlay', close: closeModals },
            { id: 'size-overlay', close: closeModals },
            { id: 'modal-overlay', close: closeModals },
            { id: 'welcome-overlay', close: () => { document.getElementById('welcome-overlay').style.display = 'none'; setScrollLock(false); } },
            { id: 'tracking-overlay', close: clearTracking },
            { id: 'upsell-overlay', close: () => { document.getElementById('upsell-overlay').style.display = 'none'; setScrollLock(false); } },
            { id: 'manual-order-overlay', close: () => { document.getElementById('manual-order-overlay').style.display = 'none'; setScrollLock(false); } },
            { id: 'delivery-calc-overlay', close: closeDeliveryCalc },
            { id: 'overlay-screen', close: closeCheckout }
        ];
        
        for (let overlay of overlays) {
            const el = document.getElementById(overlay.id);
            if (el && (el.style.display === 'flex' || el.style.display === 'block')) {
                event.preventDefault();
                overlay.close();
                history.pushState(null, null, window.location.pathname);
                return;
            }
        }
    });

    history.pushState(null, null, window.location.pathname);
</script>
</body>
</html>
